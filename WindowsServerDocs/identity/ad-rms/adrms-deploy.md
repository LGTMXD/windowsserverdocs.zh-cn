---
ms.assetid: e6fa9069-ec9c-4615-b266-957194b49e11
title: 将 AD RMS 升级到 Windows Server 2016
author: msmbaldwin
ms.author: esaggese
ms.date: 05/30/2019
ms.prod: windows-server
ms.topic: article
ms.openlocfilehash: 88af85f8e670b9c23b503e0f79af2ce8f10d045e
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/08/2020
ms.locfileid: "80854850"
---
# <a name="upgrading-ad-rms-to-windows-server-2016"></a>将 AD RMS 升级到 Windows Server 2016

## <a name="introduction"></a>介绍

Active Directory Rights Management Services （AD RMS）是一种 Microsoft 服务，用于保护敏感文档和电子邮件。 与传统的保护方法（如防火墙和 Acl）不同的是，无论文件的位置或传输方式如何，AD RMS 加密和保护都是永久性的。 

本文档提供有关从 Windows Server 2012 2012 SQL Server R2 迁移到 Windows Server 2016 和 SQL Server 2016 的指南。 同一过程可用于从 AD RMS 的旧但受支持的版本中迁移。
请注意，Active Directory Rights Management Services 不再处于活动状态，并且对于最新功能，客户应考虑迁移到[Azure 信息保护](https://azure.microsoft.com/services/information-protection/)，这提供了更全面的功能，同时提供了更完整的设备和应用程序支持。 

有关从 AD RMS 迁移到 Azure 信息保护的信息，而无需重新保护内容，请参阅[Azure 信息保护迁移文档](https://docs.microsoft.com/azure/information-protection/migrate-from-ad-rms-to-azure-rms)。

## <a name="about-the-environment-used-in-this-guide"></a>关于本指南中使用的环境

AD FS 是 AD RMS 安装的可选组件。 在本指南中，假定使用 ADFS。 如果在你的环境中没有使用 ADFS 支持 AD RMS 用户，则可以跳过引用 ADFS 的所有步骤。

在本指南中，通过执行并行安装并通过备份移动数据库，将 SQL Server 升级到 SQL Server 2016。 或者，如果你可以将 AD RMS 和 ADFS 数据库服务器升级到 SQL Server 2016，则在完成此操作后，你可以转到本文档中的下一节，无需执行本部分中的步骤。  

## <a name="installation"></a>安装

### <a name="configuring-sql-server-2016"></a>配置 SQL Server 2016

以下部分详细介绍了直接与 SQL Server 2016 配置相关的实现任务。 本指南重点介绍如何使用服务器管理器和 SQL Server Management Studio 完成这些任务。

必须在 SQL Server 2016 安装中完成这些步骤。 根据组织的标准做法和策略，将 SQL Server 2016 安装在合适的硬件上。 

#### <a name="preparing-the-sql-server"></a>准备 SQL Server

以下部分详细介绍了如何准备 SQL Server 以便升级到 SQL Server 2016，然后再升级 AD RMS 平台中的其他服务以使用 Windows Server 2016。

##### <a name="adding-cname-for-sql-server-2016-to-dns"></a>将 SQL Server 2016 的 CNAME 添加到 DNS

CNAME 用于帮助确保 Windows Server 2016 安装程序将获取适当的数据，因为它将指向新的 SQL Server 2016。 **注意：如果已对 ADFS 和 AD RMS 服务使用 CNAME，则可以继续执行后续步骤。**


**将 SQL Server 2016 的 CNAME 添加到 DNS**

1.  用域管理员凭据登录到 Windows Server 2012 R2 域控制器。

2.  打开“服务器管理器”。

3.  单击 "**工具**"，然后选择 " **DNS** " 打开 dns 管理器。

4.  从左侧导航窗格中，展开 DC 并打开 "**正向查找区域**"。

5.  打开相应的域资源，然后在右侧的视图窗格中右键单击，然后选择 "**新建别名（CNAME）** " 以开始创建 CNAME。

6.  对于 "别名"，请输入逻辑名称，使其有别于可能存在的其他名称（例如 SQLADRMS 或 SQLADFS）

7.  输入名称后，为目标主机提供 FQDN，这将是新的 SQL Server 2016 服务器。 例如. SQL2016.contoso.com）

8.  输入所有信息后，单击 **"确定"** 。

##### <a name="backup-the-ad-rms-and-adfs-databases"></a>备份 AD RMS 和 ADFS 数据库

AD RMS 和 ADFS 数据库保存了 AD RMS 所需的重要信息，例如服务器许可方证书的公钥、权限策略模板、ADFS 配置数据和日志记录信息。 如果没有这些数据库，客户端将无法颁发许可证来使用受保护的内容，还有其他问题。

在数据库中，将 AD RMS 配置数据库视为最重要，因为它存储了 SLC、权限策略模板、用户的密钥和配置信息。 因此，尽管您应该注意备份所有 AD RMS 和 ADFS 数据库，但您应该计划定期备份配置数据库。

日志数据库将有关用户请求的信息存储在证书的 AD RMS 群集中，并使用许可证。 此数据库的备份策略应基于用于保留此类信息的公司政策。

目录服务数据库对 AD RMS 功能并不重要，如果丢失最新的数据，则数据库将使用信息重新填充，因为 AD RMS 服务器接收证书请求并使用许可证。 不需要定期备份此数据库，但需要至少具有数据库的副本，因为部署 AD RMS 后它最初已配置。

**使用 Microsoft SQL Server 备份 AD RMS 和/或 ADFS 数据库**

1.  通过 SQL 2012 登录到 Windows Server 2012 R2 AD RMS 数据库服务器。

2.  依次单击 "**开始**"、"**所有程序**"、" **Microsoft SQL Server**"，然后单击 " **SQL Server Management Studio**"。

3.  在 "**连接到服务器**" 窗口中，确认承载 AD RMS 数据库的服务器在 "**服务器名称**" 框中，然后单击 "**连接**"。

4.  展开 "**数据库**"。 右键单击相应的数据库（**drm**和**Adfs**），指向 "**任务**"，然后选择 "**备份**"。

5.  对于剩余的数据库，重复步骤4。

6.  确保可以通过网络上的其他计算机访问数据库的备份，或者使用存储设备，因为在迁移过程中后面的步骤需要用到它们。

现在，你可以将数据库副本存储在安全的位置。 请记住经常备份数据库。

##### <a name="adding-domain-admin-sql-ad-rms-andor-adfs-service-account-to-sql-server-2016"></a>向 SQL Server 2016 添加域管理员、SQL、AD RMS 和/或 ADFS 服务帐户

以下步骤将演示如何将各种服务帐户添加到 SQL Server 2016，以帮助从 Windows Server 2012 R2 环境迁移数据。 这会在尝试访问内容并处理数据时给予适当的权限。

**将域管理员、SQL、AD RMS 和/或 ADFS 服务帐户添加到 SQL Server**

1.  用 SQL Server 2016 作为本地管理员帐户登录到服务器。

2.  依次单击 "**开始**"、"**所有程序**"、" **Microsoft SQL Server**"，然后单击 " **SQL Server Management Studio**"。

3.  在 "**连接到服务器**" 窗口中，确认承载 AD RMS 数据库的服务器在 "**服务器名称**" 框中，然后，对于 "身份验证"，请单击下拉菜单，然后选择 " **SQL Server 身份验证**"。

4.  在 "**登录**名" 字段中，输入本地管理员帐户的名称（例如 "localadmin"） "，然后提供相应的密码，然后单击"**连接**"。

5.  展开 "**安全性**"，然后右键单击 "**登录名**"，然后从显示的上下文菜单中选择 "**新建登录名**"。

6.  窗口出现后，请在 "**登录名**" 字段中的域管理员帐户中输入（例如 Contoso\\ContosoAdmin）

7.  从左侧导航窗格中，选择 "**服务器角色**"。

8.  然后，在服务器角色下将**sysadmin**的复选框标记为，并单击 **"确定"** 。

9.  重新启动**SQL Server 管理**。

10. 在 "**连接到服务器**" 窗口中，确认承载 AD RMS 数据库的服务器在 "**服务器名称**" 框中，单击下拉菜单，然后选择 " **Windows 身份验证**"，然后单击 "**连接**"。

##### <a name="restoring-the-ad-rms-and-adfs-databases-to-sql-server-2016"></a>将 AD RMS 和 ADFS 数据库还原到 SQL Server 2016

以下步骤将演示如何将数据从上一个 SQL Server 实例还原到新的2016实例。 这将允许新 SQL 利用以前 AD RMS 和 ADFS 数据库中的相关配置数据。

**将以前 SQL Server 的数据还原到新 SQL Server**

1.  用适当的帐户登录到带有 SQL Server 2016 的服务器。

2.  从左侧导航窗格中，右键单击 "**数据库**"，然后选择 "**还原数据库**" 以开始还原过程。

3.  在 "**源**" 下选择 "**设备**"，然后浏览到在前面的步骤中存储数据库文件的位置。

4.  选择文件后，单击 **"确定"** 。

5.  请确保已添加所有数据库文件，并单击 **"确定"** 完成该过程。

### <a name="configuring-windows-server-2016-active-directory-federation-services-ad-fs"></a>配置 Windows Server 2016 Active Directory 联合身份验证服务（AD FS）

已部署 AD FS 以提供对作为应用程序 AD RMS 的单一登录（SSO）访问。 它也配置了 AD RMS 移动设备扩展（MDE），这为最终用户启用了 Mac 和移动设备支持。

以下各节提供有关可能需要在 AD FS 部署中执行的操作任务的指导。

#### <a name="adding-a-2016-ad-fs-server-to-the-farm"></a>向场添加 2016 AD FS 服务器

你可以部署其他 AD FS 服务器以支持 AD RMS 部署。 如果要增加 AD RMS 服务器或其他应用程序的流量，或者需要停用当前用于 AD FS 的一台服务器，则可以选择执行此操作。

**将 2016 AD FS 服务器添加到场**

1.  在 Azure AD Connect 服务器上，双击 " **Azure AD Connect** " 图标以启动 Azure AD Connect 向导。

2.  在欢迎页中，单击 "**配置**"。

3.  在 "其他任务" 页上，单击 "**部署其他联合服务器**"，然后单击 "**下一步**"。

4.  在 "连接到 Azure AD" 页中，输入具有全局管理权限的帐户的用户名和密码，然后单击 "**下一步**"。

5.  在 "域管理员凭据" 页上，输入具有域管理员权限的帐户的用户名和密码，然后单击 "**下一步**"。

6.  单击 "**浏览**"，并选择使用 Azure AD Connect 配置 AD FS 场时使用的证书文件。

7.  单击 "**输入密码**" 以打开 "证书密码" 对话框。

8.  在 "密码" 字段中输入证书的密码，然后单击 **"确定"** 。

9.  单击 **“下一步”** 。

10. 在 "AD FS 服务器" 页上，输入新 AD FS 服务器的名称或 IP 地址，然后单击 "**添加**"。

11. 在 "已准备好配置" 页上，单击 "**安装**"。

12. 在 "安装完成" 页上，单击 "**退出**"。

#### <a name="raising-the-adfs-farm-behavior-level"></a>提高 ADFS 场行为级别

当部署的 ADFs 服务器超过当前环境级别（例如）时，在 Windows Server 2012 R2 上拥有一个 ADFS，然后添加 ADFS Windows Server 2016，将需要增加场行为级别。 这是确保环境使用最新信息和功能所需的。

**提高 ADFS 场行为级别**

1.  导航至 Windows Server 2016 ADFS。

2.  打开管理员 PowerShell 会话。

3.  输入以下命令： **\$凭据 = Get-Credential**

4.  将显示一个窗口，要求提供凭据，请输入域管理员凭据。

5.  然后输入以下命令： **AdfsFarmBehaviorLevelRaise-Credential \$凭据**

6.  此时将显示一条提示，询问**你是否要继续此操作？** 然后输入**以**接受提示。

7.  命令完成后，场行为级别将设置并准备就绪。

#### <a name="enabling-mobile-device-extension-logging"></a>启用移动设备扩展日志记录

移动设备扩展可以记录从最终用户设备接收的请求。 日志记录在默认情况下处于禁用状态，我们建议仅在故障排除方案中启用日志记录。 来自移动设备和台式计算机的所有请求都将记录在 AD RMS 日志记录数据库或 Azure 存储帐户中。 MDE 日志记录将为 AD RMS 使用的 SQL Server 另外创建两个表：客户端调试日志表和客户端性能日志表。

**启用移动设备扩展日志记录**

1.  在 AD RMS 服务器上，以管理员身份打开 Windows PowerShell。

2.  键入以下命令，然后按**enter**： **import-module AdRmsAdmin**

3.  键入以下命令，然后按**enter**： **New-psdrive-Name AdrmsCluster-PsProvider AdRmsAdmin-Root https://localhost**

4.  键入以下命令，然后按**enter**： **Set-itemproperty-Path AdrmsCluster：\\-Name IsLoggingEnabled-Value \$true**

如果使用 MDE 日志记录进行故障排除，则建议在解决问题后禁用它。

**禁用移动设备扩展日志记录**

1.  在 AD RMS 服务器上，以管理员身份打开 Windows PowerShell。

2.  键入以下命令，然后按**enter**： **import-module AdRmsAdmin**

3.  键入以下命令，然后按**enter**： **New-psdrive-Name AdrmsCluster-PsProvider AdRmsAdmin-Root https://localhost**

4.  键入以下命令，然后按**enter**： **Set-itemproperty-Path AdrmsCluster：\\-Name IsLoggingEnabled-Value \$false**

### <a name="upgrading-ad-rms-to-windows-server-2016"></a>将 AD RMS 升级到 Windows Server 2016

以下部分提供有关如何将基于 Windows Server 2016 的 AD RMS 服务器添加到当前 Windows Server 2012 R2 群集的指导。 服务器将添加到群集中，并将信息复制到该群集中，以便可以弃用以前的 AD RMS 服务器以释放资源。

将基于 Windows Server 2016 的 AD RMS 服务器添加到 AD RMS 群集后，基于 Windows 的早期版本的所有节点将变为不活动状态。 完成此操作后，你可以取消预配这些服务器（例如，关闭、重新调整用途或重新安装 Windows Server 2016 以加入 AD RMS 群集）。 

你可以向群集部署其他 AD RMS 服务器，以支持 AD RMS 部署上的负载。 如果 AD RMS 服务器的流量增加，还可以选择执行此操作。

本指南不涉及更改你的环境中可能使用的负载均衡机制以排除你正在弃用的服务器，并包括要添加到群集中的服务器所需的步骤。 

#### <a name="adding-a-2016-ad-rms-server"></a>添加 2016 AD RMS 服务器

如果 AD RMS 群集使用的是硬件安全模块，而不是其服务器许可方证书的集中管理的密钥，则在安装 AD RMS 之前，你将需要在服务器上安装软件和其他 HSM 项目（如密钥和配置文件）。 还需要通过物理方式或通过相关的网络配置将 HSM 连接到服务器。 遵循以下步骤的 HSM 指导。 

**添加 2016 AD RMS 服务器**

1.  在所需的 Windows Server 2016 部署上安装 AD RMS 角色。

2.  安装完成后，选择要**执行其他配置**的链接。

3.  选择 "**加入现有 AD RMS 群集**"，然后单击 "**下一步**"。

4.  在 "**选择配置数据库**" 页上，输入在 DNS 中为 2016 SQL SERVER （FQDN）指定的 CNAME。

5.  单击第二行中的 "列表"，然后从下拉**列表**中选择 " **DefaultInstance** "。

6.  在 "**配置数据库名称**" 下，选择下拉菜单，然后选择显示的 "drm" 配置。 再单击 **“下一步”** 。

7.  在 "**数据库信息**" 页上，在提供的字段中输入群集密钥密码。 完成后，单击 "**下一步**"。

8.  在向导的下一页上，指定 AD RMS 服务帐户并提供该帐户的密码，并在验证后单击 "**下一步**"。

9.  出现 "**群集**网站" 页面后，只需确保已选择相应的网站，然后单击 "**下一步**"。

10. 在 "**选择服务器身份验证证书**" 页上，选择导入的 SSL 证书，然后单击 "**下一步**"。

11. 单击“安装”以开始安装。

12. 配置完成后，需要注销并重新登录，以便管理 AD RMS。

13. 登录后，打开**服务器管理器**选择 "**工具**"，然后**Active Directory Rights Management**"。 将显示 "管理" 窗口，并指示群集在群集中具有其他服务器。

14. 如果在原始 AD RMS 群集中安装了 AD RMS 移动设备扩展，则还需要在更新的群集节点中安装 MDE。 按照 MDE 文档中的说明将 MDE 添加到 AD RMS 群集。 此时，你可以重新使用所有预先存在的节点或将其升级到 Windows Server 2016，并使用上文概述的相同过程将它们重新加入到 AD RMS 群集。 

### <a name="configuring-windows-server-2016-web-application-proxy-wap"></a>配置 Windows Server 2016 Web 应用程序代理（WAP）

以下各节提供有关可能需要在 Web 应用程序代理部署中执行的操作任务的指导。 这是一个可选步骤，如果要通过其他机制将 AD RMS 发布到 Internet，则不需要此步骤。 

#### <a name="adding-a-windows-server-2016-wap-server"></a>添加 Windows Server 2016 WAP 服务器

你可以部署其他 Web 应用程序代理服务器以支持 AD RMS 部署。 如果 AD RMS 服务器增加了流量，或者需要停用当前用于 Web 应用程序代理的服务器之一，则可以选择执行此操作。

**添加 2016 Web 应用程序代理服务器**

1.  在要设置为 Web 应用程序代理的服务器中，导航到服务器管理器控制台，然后单击 "**添加角色和功能**"。

2.  在 "**添加角色和功能向导**" 中，单击 "**下一步**"，直到进入服务器角色选择屏幕。

3.  在 "选择服务器角色" 屏幕上，选择 "**远程访问**"，然后单击 "**下一步**"，直到返回到 "选择服务器角色" 屏幕。

4.  在 "选择服务器角色" 屏幕上，选择 " **Web 应用程序代理**"，单击 "**添加功能**"，然后单击 "**下一步**"。

5.  在 "确认安装选择" 屏幕上，单击 "**安装**"。

6.  安装完成后，单击 "**关闭**"。

7.  现在可以配置服务器。 为此，请在 Web 应用程序代理服务器上打开远程访问管理控制台。 打开 "**开始**" 菜单，键入 " **ramgmtui.exe**"，然后选择该应用程序。

8.  在导航窗格中，单击 **“Web 应用程序代理”** 。

9.  在远程访问管理控制台中，单击 "**运行 Web 应用程序代理配置向导"** 。 进入向导后，单击 "**下一步**"。

10. 在 "联合服务器" 屏幕上，输入 AD FS 服务器的完全限定的域名（例如 adfs.contoso.com），然后在 AD FS 服务器上为管理员输入凭据。

11. 在 "AD FS 代理证书" 屏幕上，在当前安装在 Web 应用程序代理服务器上的证书列表中，选择要供 AD FS Proxy 的 Web 应用程序代理使用的证书，然后单击 "**下一步**"。

12. 在确认屏幕上，查看设置，然后单击 "**配置**"。

13. 配置完成后，单击 "**关闭**"。

#### <a name="dns-configuration-for-2016-wap-server"></a>2016 WAP 服务器的 DNS 配置

将 Windows Server 2016 Web 应用程序代理服务器放入到位后，将需要进行一些 DNS 更改。 这将要求使用 GoDaddy 等服务指向 2016 WAP 服务器上的 ADFS 和 AD RMS 服务。

**将 DNS 指向 WAP 服务器**

1.  导航到提供商的网站（例如 GoDaddy）。

2.  进入域管理和 DNS 管理。

3.  找到 ADFS 并 AD RMS 服务，并用 2016 WAP 服务器的公共 IP 地址替换**点**，并**保存**。

4.  更改可能需要一段时间才能传播，但一旦完成，此设置就会完成。

#### <a name="enabling-debugging-logs"></a>启用调试日志

Web 应用程序代理服务器上提供详细的日志记录信息。 你可以使用事件查看器配置高级调试日志记录。 还可以为日志的大小选择其他设置，以帮助确保分析对查看器有用。

**为 Web 应用程序代理启用调试日志**

1.  在 Web 应用程序代理上打开**事件查看器**控制台。

2.  展开 " **Microsoft** " 节点。

3.  展开 " **Windows** " 节点。

4.  打开**Web 应用程序代理**日志。

5.  然后，你将能够打开 "**管理**日志"。

6.  打开位于左上角的 "**操作**" 菜单，然后选择 "**属性**"。

7.  在 "**常规**" 选项卡下，选择用于**启用日志记录**的选项。

8.  最后，你可以自定义最大日志大小，以及达到最大事件日志大小时所发生的情况。

### <a name="configuring-high-availability-for-windows-server-2016-services"></a>为 Windows Server 2016 服务配置高可用性

以下各节提供有关在高可用性下设置 Windows Server 2016 环境所需的操作任务的指导。

#### <a name="adding-a-2016-ad-rms-server-for-high-availability"></a>添加 2016 AD RMS 服务器以实现高可用性

你可以部署其他 AD RMS 服务器以设置高可用性。 如果 AD RMS 服务器的流量增加，则可以选择执行此操作。

**添加 2016 AD RMS 服务器以实现高可用性**

1.  在所需的 Windows Server 2016 部署上安装 AD RMS 角色。

2.  安装完成后，选择要**执行其他配置**的链接。

3.  选择 "**加入现有 AD RMS 群集**"，然后单击 "**下一步**"。

4.  在 "**选择配置数据库**" 页上，输入在 DNS 中为 2016 SQL SERVER （FQDN）指定的 CNAME。

5.  单击第二行中的 "列表"，然后从下拉**列表**中选择 " **DefaultInstance** "。

6.  在 "**配置数据库名称**" 下，选择下拉菜单，然后选择显示的 "drm" 配置。 再单击 **“下一步”** 。

7.  在 "**数据库信息**" 页上，在提供的字段中输入群集密钥密码。 完成后，单击 "**下一步**"。

8.  在向导的下一页上，指定 AD RMS 服务帐户并提供该帐户的密码，并在验证后单击 "**下一步**"。

9.  出现 "**群集**网站" 页面后，只需确保已选择相应的网站，然后单击 "**下一步**"。

10. 在 "**选择服务器身份验证证书**" 页上，选择导入的 SSL 证书，然后单击 "**下一步**"。

11. 单击“安装”以开始安装。

12. 配置完成后，需要注销并重新登录，以便管理 AD RMS。

13. 登录后，打开**服务器管理器**选择 "**工具**"，然后**Active Directory Rights Management**"。 将显示 "管理" 窗口，并指示群集在群集中具有其他服务器。

14. 确认服务器安装后，配置负载平衡服务，平衡群集中不同 AD RMS 服务器之间的负载。

#### <a name="adding-a-windows-server-2016-ad-fs-server-for-high-availability"></a>添加 Windows Server 2016 AD FS Server 以实现高可用性

你可以部署其他 AD FS 服务器以设置高可用性。 如果 AD FS 服务器的流量增加，则可以选择执行此操作。 **注意：提高场行为级别后，新的数据库条目将进入 SQL Server 2016 （Adfs Configv3），并且必须删除旧的配置数据库，然后才能继续执行这些步骤。**

**添加 Windows Server 2016 AD FS Server 以实现高可用性**

1.  在所需的 Windows Server 2016 部署上安装 AD RMS 角色。

2.  安装完成后，选择要**在此服务器上配置联合身份验证服务**的链接。

3.  在向导的 "欢迎" 部分中，选择 "**将联合服务器添加到联合服务器场**" 选项，然后单击 "**下一步**"。

4.  指定正确的管理员帐户，然后单击 "**下一步**"。

5.  在 "**指定场**" 页上，**使用 SQL Server 选择 "指定现有场的数据库位置**"，然后为 "SQL 服务" 输入数据库主机名的 CNAME，然后单击 "**下一步**"。

6.  在向导的 "**指定服务帐户**" 区域下，输入 AD FS 服务帐户的凭据，然后单击 "**下一步**"。

7.  在 "**查看选项**" 中，单击 "**下一步**"。

8.  按钮变为可用时，单击 "**配置**"。

9.  配置后，重新启动计算机。

10. 确认服务器设置后，根据需要对 AD FS 服务器进行负载平衡。

#### <a name="adding-a-windows-server-2016-wap-server-for-high-availability"></a>添加 Windows Server 2016 WAP 服务器以实现高可用性

你可以部署更多 WAP 服务器来设置高可用性。 如果 AD RMS 服务器的流量增加，则可以选择执行此操作。

**添加 Windows Server 2016 Web 应用程序代理服务器以实现高可用性**

1.  在要设置为 Web 应用程序代理的服务器中，导航到服务器管理器控制台，然后单击 "**添加角色和功能**"。

2.  在 "**添加角色和功能向导**" 中，单击 "**下一步**"，直到进入服务器角色选择屏幕。

3.  在 "选择服务器角色" 屏幕上，选择 "**远程访问**"，然后单击 "**下一步**"，直到返回到 "选择服务器角色" 屏幕。

4.  在 "选择服务器角色" 屏幕上，选择 " **Web 应用程序代理**"，单击 "**添加功能**"，然后单击 "**下一步**"。

5.  在 "确认安装选择" 屏幕上，单击 "**安装**"。

6.  安装完成后，单击 "**关闭**"。

7.  现在可以配置服务器。 为此，请在 Web 应用程序代理服务器上打开远程访问管理控制台。 打开 "**开始**" 菜单，键入 " **ramgmtui.exe**"，然后选择该应用程序。

8.  在导航窗格中，单击 **“Web 应用程序代理”** 。

9.  在远程访问管理控制台中，单击 "**运行 Web 应用程序代理配置向导"** 。 进入向导后，单击 "**下一步**"。

10. 在 "联合服务器" 屏幕上，输入 AD FS 服务器的完全限定的域名（例如 adfs.contoso.com），然后在 AD FS 服务器上为管理员输入凭据。

11. 在 "AD FS 代理证书" 屏幕上，在当前安装在 Web 应用程序代理服务器上的证书列表中，选择要供 AD FS Proxy 的 Web 应用程序代理使用的证书，然后单击 "**下一步**"。

12. 在确认屏幕上，查看设置，然后单击 "**配置**"。

13. 配置完成后，单击 "**关闭**"。

14. 确认服务器设置后，对外围网络中的 WAP 服务器进行负载平衡。

#### <a name="adding-a-sql-server-2016-node-for-always-on-high-availability"></a>添加 SQL Server 2016 节点以 Always On 高可用性

你可以将其他 SQL server 部署到安装程序 Always On 高可用性。 如果 AD RMS 服务器的流量增加，则可以选择执行此操作。 **注意：请确保这两个 SQL Server 都打开了入站端口5022。**

**添加 Always On 高可用性的 SQL server 2016 服务器**

1.  在要设置为附加 SQL Server 2016 服务器的服务器中，导航到服务器管理器控制台，然后单击 "**添加角色和功能**"。

2.  在 "**选择功能**" 对话框中单击 "**下一步**"。

3.  选中 "**故障转移群集**" 复选框。 **注意：请针对原始 SQL server 2016 服务器执行此步骤，以便这两个 SQL server 都具有故障转移群集功能。**

4.  单击 "**安装**" 以安装故障转移群集功能。

5.  现在，请打开**服务器管理器**，然后选择 "**工具**"，然后**故障转移群集管理器**"。

6.  在左侧菜单窗格中，右键单击**故障转移群集管理器**，然后选择 "**创建群集**"。

7.  这将打开 "**创建群集向导**"。

8.  浏览要用于 Always On 高可用性的 SQL server 2016 服务器并将其输入到中，然后单击 "**下一步**"。

9.  您将收到一个验证警告。 选择 **"是"** 以验证群集节点，然后单击 "**下一步**"。

10. 在 "**测试选项**" 页上，选择 "**运行所有测试**" 选项，然后单击 "**下一步"。**

11. **注意：群集验证向导应返回多条警告消息，尤其是在您不使用共享存储的情况下。不是这样，如果你发现在创建 Windows Server 故障转移群集之前，你需要解决这些错误消息**。

12. 在 "**用于管理群集的访问点**" 对话框中，输入 Windows Server 故障转移群集的群集名称和虚拟 IP 地址，然后单击 "**下一步**"。

13. 在 "**摘要**" 中验证配置是否成功，然后单击 "**完成**"。

14. 返回**故障转移群集管理器，** 右键单击群集并选择 "**更多操作**"，然后选择 "**配置群集仲裁设置**"。

15. 单击 "**下一步**"，然后选择**选择仲裁见证**的选项，然后再次单击 "**下一步**"。

16. 在 "**选择仲裁见证**" 页上，选择 "**配置文件共享见证**" 选项。 再单击 **“下一步”** 。

17. 选择 "**浏览**"，然后在 "文件共享路径" 对话框中找到要使用的文件共享的路径。 单击 **“下一步”** 。

18. 在 "确认" 页上，单击 "**下一步**"。

19. 在 "摘要" 页上，单击 "**完成**"。

20. 现在，请打开 "**开始**" 菜单，搜索**SQL Server 配置管理器**。

21. 右键单击 SQL Server 名称，然后选择 "**属性**"。

22. 在 "属性" 对话框中，选择 " **AlwaysOn 高可用性**" 选项卡。选中 "**启用 AlwaysOn 可用性组**" 复选框。 单击“确定”。 **注意：请在两个 SQL server 2016 服务器上执行此操作。**

23. 然后重新启动 SQL Server 服务。

24. 现在，请打开 "**开始**" 菜单，搜索 " **SQL Server Management Studio** "，然后从左侧导航窗格中，右键单击 "**可用性组**"，然后单击 "**新建可用性组向导**"，然后单击 "**下一步**"。

25. 在 "**指定可用性组名称**" 页中，选择组名称（例如 SQLAvailabilityGroup2016）。 再单击 **“下一步”** 。

26. 在 "**选择数据库**" 部分下，指定数据库。 然后单击“下一步”。 **注意：某些数据库可能需要再次备份或置于完全恢复模式**。

27. 在 "**指定副本**" 页上，单击 "**添加副本**" 按钮，然后选择其他 2016 SQL Server。

28. 添加另一台服务器后，单击相应的复选框，并将辅助服务器设置为可读辅助服务器。

29. 导航到 "**终结点**" 选项卡，然后单击 "**刷新**" 选项。 同时，还可以滚动浏览并确保主节点和辅助节点上的服务帐户相同。

30. 现在，选择 "**备份首**选项" 选项卡，然后选择 "**首选辅助**" 选项。

31. 转到 "**侦听器**" 选项卡。

32. 指定一个名称（例如 SQLListener）并确保端口为**1433** ，然后单击 "**下一步**"。

33. 在向导的 "**选择初始数据同步**" 页中，选择 "**完全**" 选项并指定所有 SQL 服务器都可以访问的网络位置，然后单击 "**下一步**"。

34. 最后，单击 "**完成**" 即可完成该过程。

### <a name="decommission-windows-server-2012-r2-nodes"></a>停止 Windows Server 2012 R2 节点

以下各节提供了有关操作任务的指导，在成功将 AD RMS 群集升级到 Windows Server 2016 后，你可能需要删除 Windows Server 2012 R2 服务器。

#### <a name="removing-a-windows-server-2012-r2-ad-rms-server"></a>删除 Windows Server 2012 R2 AD RMS 服务器

升级之后，可以删除不必要的 AD RMS 服务器。 如果需要解除 AD RMS 服务器的授权，则可以选择执行此操作。

**删除** **Windows server 2012 R2 AD RMS 服务器**

1.  在服务器管理器中的 Windows Server 2012 R2 AD RMS 服务器上，从右上方菜单中选择 "**管理**"，然后选择 "**删除角色和功能**"。

2.  "**删除角色和功能向导**" 将打开，并在 "**开始之前**" 屏幕上，单击 "**下一步**"。

3.  在**服务器选择**屏幕上，单击 "**下一步**"。

4.  在 "**服务器角色**" 屏幕上，删除**Active Directory Rights Management Services**旁边的复选标记，然后单击 "**下一步**"。

5.  在**功能**屏幕上，单击 "**下一步**"。

6.  在**确认**屏幕上，单击 "**删除**"。

7.  完成此过程后，请重新启动服务器。

8.  你现在可以关闭此服务器，并根据需要重新分配资源。
