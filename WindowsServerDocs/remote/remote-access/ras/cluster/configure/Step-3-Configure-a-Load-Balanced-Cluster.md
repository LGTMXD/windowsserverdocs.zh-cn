---
title: 步骤3配置负载平衡群集
description: 本主题是在 Windows Server 2016 的群集中部署远程访问指南的一部分。
manager: brianlic
ms.prod: windows-server
ms.technology: networking-ras
ms.topic: article
ms.assetid: f000066e-7cf8-4085-82a3-4f4fe1cb3c5c
ms.author: lizross
author: eross-msft
ms.openlocfilehash: 4e6378062215186ab877583a45481fc0b1cc6186
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/23/2020
ms.locfileid: "86965899"
---
# <a name="step-3-configure-a-load-balanced-cluster"></a>步骤3配置负载平衡群集

>适用于：Windows Server（半年频道）、Windows Server 2016

为群集准备好服务器后，在单个服务器上配置负载平衡，配置所需的证书，然后部署群集。  
  
|任务|说明|  
|----|--------|  
|[3.1 配置 IPv6 前缀](#BKMK_Prefix)|如果公司环境是 IPv4 + IPv6 或仅限 IPv6，则在单个远程访问服务器上，确保分配给 DirectAccess 客户端计算机的 IPv6 前缀足够大，以涵盖群集中的所有服务器。|  
|[3.2 启用负载均衡](#BKMK_NLB)|在单个远程访问服务器上启用负载均衡。|  
|[3.3 安装 IP-HTTPS 证书](#BKMK_InstallIPHTTP)|群集中的每个服务器都需要使用服务器证书对 ip-https 连接进行身份验证。  从单个远程访问服务器导出 IP-HTTPS 证书，并将其部署到要添加到群集的每个服务器上。 仅当使用非自签名证书时，才需要此项。|  
|[3.4 安装网络位置服务器证书](#BKMK_NLS)|如果单一服务器本地部署了网络位置服务器，则需要在群集中的每个服务器上部署网络位置服务器证书。 如果网络位置服务器托管在外部服务器上，则不需要在每个服务器上使用证书。 仅当使用非自签名证书时，才需要此项。|  
|[3.5 将服务器添加到群集](#BKMK_Add)|将所有服务器添加到群集。 不能在要添加的服务器上配置远程访问。|  
|[3.6 从群集中删除服务器](#BKMK_remove)|从群集中删除服务器的说明。|  
|[3.7 禁用负载均衡](#BKBK_disable)|有关禁用负载平衡的说明。|  
  
> [!NOTE]  
> 为 DIP 选择的 IP 地址不得在群集中第一个远程访问服务器的网络适配器上使用。 开始 DirectAccess 部署，同时将 VIP 和 DIP 添加到网络适配器，都将导致失败。  
  
> [!NOTE]  
> 请确保不要使用网络中其他计算机上已存在的 DIP。  
  
## <a name="31-configure-the-ipv6-prefix"></a><a name="BKMK_Prefix"></a>3.1 配置 IPv6 前缀  
  
### <a name="to-configure-the-prefix"></a><a name="configDA"></a>配置前缀  
  
1.  在远程访问服务器上，单击 "**开始**"，然后单击 "**远程访问管理**"。 如果出现了“用户帐户控制”**** 对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”****。  
  
2.  在远程访问管理控制台中，单击“配置”****。  
  
3.  在控制台的中间窗格中，在 "**步骤 2 DirectAccess 服务器**" 区域中，单击 "**编辑**"。  
  
4.  单击 "**前缀配置**"。 在 "**前缀配置**" 页上，在 "**分配给 DirectAccess 客户端计算机的 ipv6 前缀**" 中，输入子网长度为59（例如， **2001： db8：1：1000：：/59**）用于 directaccess 客户端计算机的 ipv6 前缀。 如果 VPN 还启用了 IPv6，则将显示 IPv6 前缀，并且子网长度需要更改为59。 单击“下一步”。  
  
5.  在控制台的中间窗格中，单击 "**完成**"。  
  
6.  在 "**远程访问查看**" 对话框中，检查配置设置，然后单击 "**应用**"。 在 **“应用远程访问设置向导设置”** 对话框中，单击 **“关闭”**。  
  
## <a name="32-enable-load-balancing"></a><a name="BKMK_NLB"></a>3.2 启用负载均衡  
  
#### <a name="to-enable-load-balancing"></a>启用负载平衡  
  
1.  在配置的 DirectAccess 服务器上，单击 "**开始**"，然后单击 "**远程访问管理**"。 如果出现了“用户帐户控制”**** 对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”****。  
  
2.  在远程访问管理控制台的左窗格中，单击 "**配置**"，然后在 "**任务**" 窗格中，单击 "**启用负载均衡**"。  
  
3.  在 "启用负载平衡" 向导中，单击 "**下一步**"。  
  
4.  根据你在规划步骤中选择的内容：  
  
    1.  Windows NLB：在 "**负载平衡方法**" 页上，单击 "**使用 Windows 网络负载平衡（NLB）**"，然后单击 "**下一步**"。  
  
    2.  外部负载均衡器：在 "**负载平衡方法**" 页上，单击 "**使用外部负载均衡器**"，然后单击 "**下一步**"。  
  
5.  在单个网络适配器部署中，在 "**专用 IP 地址**" 页上执行以下操作，然后单击 "**下一步**"：  
  
    1.  在 " **IPv4 地址**" 框中，输入此远程访问服务器的新 IPv4 地址;当前 IPv4 地址将是负载平衡群集的虚拟 IP 地址（VIP）。 在 "**子网掩码**" 框中，输入子网掩码。  
  
    2.  如果公司环境是本机 IPv6，则在 " **ipv6 地址**" 框中，输入此远程访问服务器的新 IPv6 地址;当前 IPv6 地址将是负载平衡群集的 VIP。 在 "**子网前缀长度**" 框中，输入子网前缀长度。  
  
6.  在两个网络适配器部署中，在 "**外部专用 IP 地址**" 页上执行以下操作，然后单击 "**下一步**"：  
  
    1.  在 " **IPv4 地址**" 框中，输入此远程访问服务器的新外部 IPv4 地址;当前 IPv4 地址将是负载平衡群集的虚拟 IP 地址（VIP）。 在 "**子网掩码**" 框中，输入子网掩码。  
  
    2.  如果远程访问服务器的面向 internet 的网络适配器上配置了当前的本机 IPv6 地址，请在 " **IPv6 地址**" 框中输入此远程访问服务器的新外部 IPv6 地址;当前 IPv6 地址将是负载平衡群集的 VIP。 在 "**子网前缀长度**" 框中，输入子网前缀长度。  
  
7.  在两个网络适配器部署中，在 "**内部专用 IP 地址**" 页上执行以下操作，然后单击 "**下一步**"：  
  
    1.  在 " **IPv4 地址**" 框中，输入此远程访问服务器的新的内部 IPv4 地址;当前 IPv4 地址将是负载平衡群集的 VIP。 在 "**子网掩码**" 框中，输入子网掩码。  
  
    2.  如果公司环境是本机 IPv6，则在 " **ipv6 地址**" 框中，输入此远程访问服务器的新内部 IPv6 地址;当前 IPv6 地址将是负载平衡群集的 VIP。 在 "**子网前缀长度**" 框中，输入子网前缀长度。  
  
8.  在 "**摘要**" 页上，单击 "**提交**"。  
  
9. 在 "**启用负载平衡**" 对话框中，单击 "**关闭**"。  
  
10. 在 "启用负载平衡" 向导中，单击 "**关闭**"。  
  
    > [!NOTE]  
    > 如果正在使用外部负载均衡，请记下虚拟 Ip，并将其提供给外部负载平衡器。  
  
![Windows PowerShell](../../../../media/Step-3-Configure-a-Load-Balanced-Cluster/PowerShellLogoSmall.gif)***<em>windows powershell 等效命令</em>***  
  
下面一个或多个 Windows PowerShell cmdlet 执行的功能与前面的过程相同。 在同一行输入每个 cmdlet（即使此处可能因格式限制而出现多行换行）。  
  
如果在规划步骤中选择使用 Windows NLB，则执行以下操作：  
  
```  
Set-RemoteAccessLoadBalancer -InternetDedicatedIPAddress "2.1.1.20/255.255.255.0" -InternalDedicatedIPAddress @("10.1.1.30/255.255.255.0","3ffe::20/64") -InternetVirtualIPAddress @("2.1.1.1/255.255.255.0","2.1.1.2/255.255.255.0") -InternalVirtualIPAddress @("10.1.1.2/255.255.255.0","3ffe::2/64")  
```  
  
如果在规划步骤中选择使用外部负载均衡器，请执行以下操作：  
  
```  
Set-RemoteAccessLoadBalancer -InternetDedicatedIPAddress "2.1.1.20/255.255.255.0" -InternalDedicatedIPAddress @("10.1.1.30/255.255.255.0","3ffe::20/64") -UseThirdPrtyLoadBalancer  
```  
  
> [!NOTE]  
> 如果使用过渡 Gpo，则建议不要包含对任何其他设置的负载平衡器设置更改。 必须先应用对负载平衡器设置所做的任何更改，然后再进行其他配置更改。 此外，在新的 DirectAccess 服务器上配置负载平衡器之后，请在更改与新群集相关的其他 DirectAccess 设置之前，留出一段时间让 IP 更改应用并复制到企业中的 DNS 服务器。  
  
## <a name="33-install-the-ip-https-certificate"></a><a name="BKMK_InstallIPHTTP"></a>3.3 安装 IP-HTTPS 证书  
必须至少具有本地 **Administrators** 组中的成员身份或同等身份才能完成此过程。  
  
### <a name="to-install-the-ip-https-certificate"></a><a name="IPHTTPSCert"></a>安装 IP-HTTPS 证书  
  
1.  在配置的远程访问服务器上，单击 "**开始**"，键入**mmc** ，然后按 enter。 如果出现了“用户帐户控制”**** 对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”****。  
  
2.  在 MMC 控制台的“文件”菜单上，单击“添加/删除管理单元”。  
  
3.  在 "**添加或删除管理单元**" 对话框中，依次单击 "**证书**"、"**添加**"、"**计算机帐户**"、"**下一步**"、"**完成**"，然后单击 **"确定"**。  
  
4.  在控制台的左窗格中，导航到 "**证书（本地计算机） \**"。 右键单击 IP-HTTPS 证书，指向 "**所有任务**"，然后单击 "**导出**"。  
  
5.  在 **“欢迎使用‘证书导出向导’”** 页面上，单击 **“下一步”**。  
  
6.  在“导出私钥”**** 页面上，单击“是，导出私钥”****，然后单击“下一步”****。  
  
7.  在 "**导出文件格式**" 页上，单击 "**个人信息交换-PKCS #12 （。PFX）**，然后单击 "**下一步**"。  
  
8.  在 "**安全**" 页上，选中 "**密码**" 复选框，在 "**密码**" 框中输入密码并确认密码，然后单击 "**下一步**"。  
  
9. 在 "**要导出的文件**" 页上，输入证书文件的名称并将其保存到桌面，然后单击 "**下一步**"。  
  
10. 在“完成证书导出向导”页中单击“完成”。  
  
11. 在 "**证书导出向导**" 对话框中，单击 **"确定"**。  
  
12. 将该证书复制到要作为群集成员的所有服务器。  
  
13. 在新 DirectAccess 服务器上，单击 "**开始**"，键入**mmc** ，然后按 enter。 如果出现了“用户帐户控制”**** 对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”****。  
  
14. 在 MMC 控制台的“文件”菜单上，单击“添加/删除管理单元”。  
  
15. 在 "**添加或删除管理单元**" 对话框中，依次单击 "**证书**"、"**添加**"、"**计算机帐户**"、"**下一步**"、"**完成**"，然后单击 **"确定"**。  
  
16. 在控制台的左窗格中，导航到 "**证书（本地计算机） \**"。 右键单击 "**证书**" 节点，指向 "**所有任务**"，然后单击 "**导入**"。  
  
17. 在 "**欢迎使用证书导入向导**" 页上，单击 "**下一步**"。  
  
18. 在 "**要导入的文件**" 页上，单击 "**浏览**" 找到证书。 选择该证书，然后单击 "**下一步**"。  
  
19. 在 "**私钥保护**" 页上的 "**密码**" 框中，键入密码，然后单击 "**下一步**"。  
  
20. 在“证书存储”**** 页上，单击“下一步”****。  
  
21. 在“正在完成证书导入向导”**** 页上，单击“完成”****。  
  
22. 在 "**证书导入向导**" 对话框中，单击 **"确定"**。  
  
23. 在希望成为群集成员的所有服务器上重复步骤13-22。  
  
## <a name="34-install-the-network-location-server-certificate"></a><a name="BKMK_NLS"></a>3.4 安装网络位置服务器证书  
必须至少具有本地 **Administrators** 组中的成员身份或同等身份才能完成此过程。  
  
#### <a name="to-install-a-certificate-for-network-location"></a>为网络位置安装证书  
  
1.  在远程访问服务器上，单击 "**开始**"，键入**mmc**，然后按 enter。 如果出现了“用户帐户控制”**** 对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”****。  
  
2.  单击 "**文件**"，然后单击 "**添加/删除管理单元**"。  
  
3.  依次单击 "**证书**"、"**添加**"、"**计算机帐户**"、"**下一步**"、"**本地计算机**"、"**完成**" 和 **"确定"**。  
  
4.  在证书管理单元的控制台树中，依次打开****“证书(本地计算机)\个人\证书”。  
  
5.  右键单击****“证书”，指向****“所有任务”，然后单击****“申请新证书”。  
  
6.  单击“下一步”**** 两次。  
  
7.  在 "**申请证书**" 页上，单击 "Web 服务器证书" 模板，然后单击 "**注册此证书需要详细信息**"。  
  
    如果未显示 "Web 服务器证书" 模板，请确保远程访问服务器计算机帐户具有 Web 服务器证书模板的 "注册" 权限。 有关详细信息，请参阅[配置 Web 服务器证书模板上的权限](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ee649249(v=ws.10))。  
  
8.  在 "**证书属性**" 对话框的 "**使用者**" 选项卡的 "**使用者名称**" 中，为 "**类型**" 选择 "**公用名**"。  
  
9. 在 "**值**" 中，为网络位置服务器网站的 intranet 名称键入完全限定的域名（FQDN）（例如，nls.corp.contoso.com），然后单击 "**添加**"。  
  
10. 依次单击****“确定”、****“注册”和****“完成”。  
  
11. 在 "证书" 管理单元的详细信息窗格中，验证具有 FQDN 的新证书是否已注册到**服务器身份验证**的**预期目的**。  
  
12. 右键单击该证书，然后单击 "**属性**"。  
  
13. 在 "**友好名称**" 中，键入**网络位置证书**，然后单击 **"确定"**。  
  
    > [!TIP]  
    > 步骤12和13是可选的，但在配置远程访问时，可以更轻松地选择网络位置的证书。  
  
14. 在要作为群集成员的所有服务器上重复此过程。  
  
## <a name="35-add-servers-to-the-cluster"></a><a name="BKMK_Add"></a>3.5 将服务器添加到群集  
 
  
#### <a name="to-add-servers-to-the-cluster"></a>向群集添加服务器  
  
1.  在配置的 DirectAccess 服务器上，单击 "**开始**"，然后单击 "**远程访问管理**"。 如果出现了“用户帐户控制”**** 对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”****。  
  
2.  在远程访问管理控制台中，单击“配置”****。 在 "**任务**" 窗格中的 "**负载均衡群集**" 下，单击 "**添加或删除服务器**"。  
  
3.  在 "**添加或删除服务器**" 对话框中，单击 "**添加服务器**"。  
  
4.  在 "**添加服务器**" 对话框中的 "**选择服务器**" 页上，输入其他远程访问服务器的名称，然后单击 "**下一步**"。  
  
5.  在 "**网络适配器**" 页上，执行以下操作之一：  
  
    -   如果要部署具有两个网络适配器的拓扑，请在 "**外部适配器**" 中选择连接到外部网络的适配器。 在 "**内部适配器**" 中，选择连接到内部网络的适配器。  
  
    -   如果要使用一个网络适配器部署拓扑，请在 "**网络适配器**" 中选择连接到内部网络的适配器。  
  
6.  在 "**网络适配器**" 页上，在 "**选择用于验证 ip-https 连接的证书**" 页上，单击 "**浏览**" 查找并选择 Ip-https 证书，然后单击 "**下一步**"。  
  
7.  在 "**网络位置服务器**" 页上，单击 "**浏览**" 为在远程访问服务器上运行的网络位置服务器网站选择证书，然后单击 "**下一步**"。  
  
    > [!NOTE]  
    > 仅当网络位置服务器网站在远程访问服务器上运行时，才会显示 "**网络位置服务器**" 页。  
  
    > [!NOTE]  
    > 如果还在远程访问服务器上配置了 VPN，则此时会要求你添加 VPN IP 地址池信息。  
  
8.  在 "**摘要**" 页上，单击 "**添加**"。  
  
9. 在“完成”**** 页上，单击“关闭”****。  
  
10. 对于要添加到群集的所有远程访问服务器，请重复此步骤。  
  
11. 在 "**添加或删除服务器**" 对话框中，单击 "**提交**"。  
  
12. 在 "**添加和删除服务器**" 对话框中，单击 "**关闭**"。  
  
![Windows PowerShell](../../../../media/Step-3-Configure-a-Load-Balanced-Cluster/PowerShellLogoSmall.gif)***<em>windows powershell 等效命令</em>***  
  
下面一个或多个 Windows PowerShell cmdlet 执行的功能与前面的过程相同。 在同一行输入每个 cmdlet（即使此处可能因格式限制而出现多行换行）。  
  
```  
Add-RemoteAccessLoadBalancerNode -RemoteAccessServer <server name>  
```  
  
> [!NOTE]  
> 如果未在负载平衡群集中启用 VPN，则在使用 Windows PowerShell cmdlet 将新服务器添加到群集时不应提供任何 VPN 地址范围。 如果错误地执行了此操作，请从群集中删除服务器，并再次将其添加到群集中，而无需指定 VPN 地址范围。  
  
## <a name="36-remove-a-server-from-the-cluster"></a><a name="BKMK_remove"></a>3.6 从群集中删除服务器  
 
  
#### <a name="to-remove-a-server-from-the-cluster"></a>从群集中删除服务器  
  
1.  在配置的远程访问服务器上，单击 "**开始**"，然后单击 "**远程访问管理**"。 如果出现了“用户帐户控制”**** 对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”****。  
  
2.  在远程访问管理控制台中，单击“配置”****。 在 "**任务**" 窗格中的 "**负载均衡群集**" 下，单击 "**添加或删除服务器**"。  
  
3.  在 "**添加或删除服务器**" 对话框中，选择要删除的远程访问服务器，然后单击 "**删除服务器**"。  
  
4.  在 "**删除服务器警告**" 对话框中，确保选择了正确的服务器，然后单击 **"确定"**。  
  
5.  对于要从群集中删除的所有远程访问服务器，请重复此步骤。  
  
6.  在 "**添加或删除服务器**" 对话框中，单击 "**提交**"。  
  
7.  在 "**添加和删除服务器**" 对话框中，单击 "**关闭**"。  
  
![Windows PowerShell](../../../../media/Step-3-Configure-a-Load-Balanced-Cluster/PowerShellLogoSmall.gif)***<em>windows powershell 等效命令</em>***  
  
下面一个或多个 Windows PowerShell cmdlet 执行的功能与前面的过程相同。 在同一行输入每个 cmdlet（即使此处可能因格式限制而出现多行换行）。  
  
```  
Remove-RemoteAccessLoadBalancerNode -RemoteAccessServer <server name>  
```  
  
## <a name="37-disable-load-balancing"></a><a name="BKBK_disable"></a>3.7 禁用负载均衡  
[使用 Windows PowerShell 执行此步骤](assetId:///7a817ca0-2b4a-4476-9d28-9a63ff2453f9)  
  
#### <a name="to-disable-load-balancing"></a>禁用负载均衡  
  
1.  在配置的 DirectAccess 服务器上，单击 "**开始**"，然后单击 "**远程访问管理**"。 如果出现了“用户帐户控制”**** 对话框，请确认其所显示的操作是你要采取的操作，然后单击“是”****。  
  
2.  在远程访问管理控制台中，单击“配置”****。 在 "**任务**" 窗格中的 "**负载均衡群集**" 下，单击 "**禁用负载均衡**"。  
  
3.  在 "**禁用负载平衡**" 对话框中，单击 **"确定"**。  
  
4.  在 "**禁用负载平衡**" 对话框中，单击 "**关闭**"。  
  
![Windows PowerShell](../../../../media/Step-3-Configure-a-Load-Balanced-Cluster/PowerShellLogoSmall.gif)***<em>windows powershell 等效命令</em>***  
  
下面一个或多个 Windows PowerShell cmdlet 执行的功能与前面的过程相同。 在同一行输入每个 cmdlet（即使此处可能因格式限制而出现多行换行）。  
  
```  
set-RemoteAccessLoadBalancer -disable  
```  
  
禁用负载均衡将从所有服务器（其执行的服务器除外）中删除远程访问设置和 NLB 设置（如果配置）。 在此远程访问服务器上，将删除 NLB 设置（如果已配置），但会保留远程访问设置。  
  
单击 "**删除配置设置**" 将从部署中的所有服务器中删除远程访问和 NLB （如果已配置）。  
  
> [!NOTE]  
> -   如果在部署负载平衡时卸载远程访问，则所有服务器都将保留 Dip。 Vip 被删除。 这会导致企业网络中以 Vip 地址为目标的所有路由失败。 这还会影响已解析为 Vip 的 DNS 条目，如网络位置服务器证书使用者名称。 若要避免此问题，请禁用负载均衡，这会在最后一台远程访问服务器上保留 Vip，然后卸载远程访问。  
> -   使用**RemoteAccessLoadBalancer** cmdlet 禁用负载平衡后，请在运行任何其他 cmdlet 之前等待2分钟。 此操作还应在运行**RemoteAccessLoadBalancer-disable** cmdlet 之后运行其他 cmdlet 的任何脚本中完成。  
> -   禁用负载平衡会将群集的虚拟 IP 地址更改为专用 IP 地址。 因此，在服务器上缓存的 DNS 条目过期之前，查询服务器名称的任何操作都将失败。 请确保在禁用负载平衡之后不运行任何远程访问 PowerShell cmdlet，直至服务器上的缓存过期。 如果你尝试在另一个域中的另一台计算机上禁用负载平衡，则此问题更常见。 如果你从远程访问管理控制台禁用了负载平衡，并且可能会阻止加载配置，也会发生这种情况。 缓存过期或刷新后，将加载配置。  
  
## <a name="see-also"></a><a name="BKMK_Links"></a>另请参阅  
  
-   [步骤4：验证群集](Step-4-Verify-the-Cluster.md)  
  
