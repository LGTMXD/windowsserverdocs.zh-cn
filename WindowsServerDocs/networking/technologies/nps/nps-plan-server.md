---
title: 将 NPS 规划为 RADIUS 服务器
description: 本主题提供有关 Windows Server 2016 中的网络策略服务器 RADIUS 服务器部署规划的信息。
manager: brianlic
ms.topic: article
ms.assetid: 2900dd2c-0f70-4f8d-9650-ed83d51d509a
ms.author: lizross
author: eross-msft
ms.openlocfilehash: 73e85d9582e447466115ce30047a3968a8f457d8
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/07/2020
ms.locfileid: "87952002"
---
# <a name="plan-nps-as-a-radius-server"></a>将 NPS 规划为 RADIUS 服务器

>适用于：Windows Server（半年频道）、Windows Server 2016

将网络策略服务器 \( NPS \) 作为远程身份验证拨入用户服务 (RADIUS) 服务器部署时，NPS 将为本地域和信任本地域的域的连接请求执行身份验证、授权和记帐。 您可以使用这些规划指南来简化您的 RADIUS 部署。

这些规划准则不包括希望将 NPS 部署为 RADIUS 代理的情况。 将 NPS 部署为 RADIUS 代理时，NPS 会将连接请求转发到运行 NPS 的服务器或远程域、不受信任的域中的其他 RADIUS 服务器。

在你的网络上将 NPS 部署为 RADIUS 服务器之前，请使用以下准则来规划你的部署。

- 规划 NPS 配置。

- 规划 RADIUS 客户端。

- 规划身份验证方法的使用。

- 规划网络策略。

- 规划 NPS 计帐。

## <a name="plan-nps-configuration"></a>规划 NPS 配置

您必须决定 NPS 是哪个域的成员。 对于多域环境，NPS 可以对其所属域中的用户帐户以及信任 NPS 本地域的所有域的凭据进行身份验证。 若要允许 NPS 在授权过程中读取用户帐户的拨入属性，必须将 NPS 的计算机帐户添加到每个域的 RAS 和 NPSs 组。

确定 NPS 的域成员身份后，服务器必须配置为使用 RADIUS 协议与 RADIUS 客户端（也称为网络访问服务器）进行通信。 此外，你还可以配置 NPS 记录在事件日志中的事件类型，并且可以输入服务器的说明。

### <a name="key-steps"></a>关键步骤

在规划 NPS 配置过程中，你可以使用以下步骤。

- 确定 NPS 用于接收来自 RADIUS 客户端的 RADIUS 消息的 RADIUS 端口。 对于 RADIUS 身份验证消息，默认端口为 UDP 端口1812和1645，为 RADIUS 记帐消息设置端口1813和1646。

- 如果使用多个网络适配器配置了 NPS，请确定允许其 RADIUS 流量允许的适配器。

- 确定希望 NPS 在事件日志中记录的事件类型。 可以记录拒绝的身份验证请求、成功的身份验证请求或两种类型的请求。

- 确定是否要部署多个 NPS。 若要为基于 RADIUS 的身份验证和记帐提供容错能力，请使用至少两个 NPSs。 一个 NPS 用作主 RADIUS 服务器，另一个用作备份。 然后在这两个 NPSs 上配置每个 RADIUS 客户端。 如果主 NPS 变为不可用，则 RADIUS 客户端会将访问请求消息发送到备用 NPS。

- 规划用于将一个 NPS 配置复制到其他 NPSs 的脚本，以节省管理开销，并阻止服务器的错误配置。 NPS 提供 Netsh 命令，使你可以复制所有或部分 NPS 配置以导入到另一个 NPS。 可以在 Netsh 提示符下手动运行这些命令。 但是，如果你将命令序列另存为脚本，则可以在以后选择更改服务器配置时运行该脚本。

## <a name="plan-radius-clients"></a>规划 RADIUS 客户端

RADIUS 客户端是网络访问服务器，例如无线访问点、虚拟专用网络 (VPN) 服务器、支持 X 的交换机和拨号服务器。 将连接请求消息转发到 RADIUS 服务器的 RADIUS 代理也是 RADIUS 客户端。 NPS 支持符合 RADIUS 协议的所有网络访问服务器和 RADIUS 代理，如 RFC 2865 "远程身份验证拨入用户服务 (RADIUS) " 中所述，RFC 2866 "RADIUS 记帐"。

>[!IMPORTANT]
>访问客户端（如客户端计算机）不是 RADIUS 客户端。 只有支持 RADIUS 协议的网络访问服务器和代理服务器是 RADIUS 客户端。

此外，无线访问点和交换机都必须能够 802.1 X 身份验证。 如果要部署可扩展的身份验证协议 \( EAP \) 或受保护的可扩展身份验证协议 \( PEAP \) ，则访问点和交换机必须支持使用 EAP。

若要为无线访问点的 PPP 连接测试基本互操作性，请将访问点和访问客户端配置为使用密码身份验证协议 (PAP) 。 使用其他基于 PPP 的身份验证协议（如 PEAP），直到你测试了你打算用于网络访问的身份验证协议。

### <a name="key-steps"></a>关键步骤

在规划 RADIUS 客户端的过程中，可以使用以下步骤。

- 记录 (Vsa 的供应商特定属性) 必须在 NPS 中进行配置。 如果网络访问服务器需要 Vsa，请在 NPS 中配置网络策略时记录 VSA 信息以供以后使用。

- 记录 RADIUS 客户端和 NPS 的 IP 地址，以简化所有设备的配置。 部署 RADIUS 客户端时，必须将其配置为使用 RADIUS 协议，并将 NPS IP 地址输入为身份验证服务器。 将 NPS 配置为与 RADIUS 客户端通信时，必须在 NPS 管理单元中输入 RADIUS 客户端 IP 地址。

- 在 RADIUS 客户端和 NPS 管理单元中创建用于配置的共享机密。 在 NPS 中配置 RADIUS 客户端时，你必须使用共享机密或密码配置 RADIUS 客户端。

## <a name="plan-the-use-of-authentication-methods"></a>规划身份验证方法的使用

NPS 支持基于密码的身份验证和基于证书的身份验证方法。 但是，并非所有网络访问服务器都支持相同的身份验证方法。 在某些情况下，可能需要根据网络访问类型部署不同的身份验证方法。

例如，你可能想要为你的组织部署无线和 VPN 访问，但对于每种类型的访问，请使用不同的身份验证方法： VPN 连接的 EAP-TLS，因为对于 802.1 X 无线连接，eap 使用传输层安全性 (eap-tls) 提供和 PEAP-CHAP v2。

PEAP with Microsoft 质询握手身份验证协议版本 2 (PEAP-GTC v2) 提供一个名为 "快速重新连接" 的功能，该功能专门用于便携式计算机和其他无线设备。 快速重新连接使无线客户端可以在同一网络上的无线访问点之间移动，而无需在每次与新的访问点关联时进行身份验证。 这为无线用户提供了更好的体验，并允许他们在访问点之间移动，而无需重新键入其凭据。
由于 "快速重新连接" 和 "PEAP-GTC v2" 提供的安全性，PEAP-ms-chap v2 是一种用于无线连接的身份验证方法的逻辑选择。

对于 VPN 连接，EAP-TLS 是一种基于证书的身份验证方法，它提供强大的安全性，可保护网络流量，即使是通过 Internet 从家里或移动计算机传输到组织 VPN 服务器。

### <a name="certificate-based-authentication-methods"></a>基于证书的身份验证方法

基于证书的身份验证方法具有提供强大安全性的优点;而且，它们具有比基于密码的身份验证方法更难部署的缺点。

PEAP MS-CHAP v2 和 EAP-TLS 都是基于证书的身份验证方法，但是它们之间的差异和部署方式有很多差异。

### <a name="eap-tls"></a>EAP-TLS

EAP-TLS 同时使用证书来进行客户端和服务器身份验证，并要求您在您的组织中部署 (PKI) 的公钥基础结构。 部署 PKI 可能会很复杂，并且需要计划阶段，这与规划将 NPS 用作 RADIUS 服务器无关。

使用 EAP-TLS 时，NPS 将从证书颁发机构 CA 注册服务器证书 \( \) ，并将证书保存在本地计算机上的证书存储中。 在身份验证过程中，当 NPS 向访问客户端发送其服务器证书以向访问客户端证明其身份时，将发生服务器身份验证。 访问客户端将检查各种证书属性，以确定证书是否有效，以及在服务器身份验证期间是否适用于使用。 如果服务器证书满足最低服务器证书要求并且由访问客户端信任的 CA 颁发，则 NPS 已成功通过客户端的身份验证。

同样，客户端身份验证在客户端将其客户端证书发送到 NPS 以向 NPS 证明其身份时在身份验证过程中进行。 NPS 检查证书，如果客户端证书满足最低客户端证书要求并且由 NPS 信任的 CA 颁发，则 NPS 会成功对访问客户端进行身份验证。

尽管服务器证书必须存储在 NPS 上的证书存储中，但客户端或用户证书可以存储在客户端上的证书存储区中，也可以存储在智能卡上。

要使此身份验证过程成功，所有计算机都必须在本地计算机和当前用户的 "受信任的根证书颁发机构" 证书存储中具有组织的 CA 证书。

### <a name="peap-ms-chap-v2"></a>PEAP-MS-CHAP v2

PEAP-MS-CHAP v2 使用证书进行服务器身份验证，并使用基于密码的凭据进行用户身份验证。 由于证书仅用于服务器身份验证，因此无需部署 PKI 即可使用 PEAP-MS-CHAP v2。 部署 PEAP-MS-CHAP v2 时，可以通过以下两种方式之一获取 NPS 的服务器证书：

- 可以 (AD CS) 安装 Active Directory 证书服务，然后将证书自动注册到 NPSs。 如果使用此方法，则还必须将 CA 证书注册到连接到网络的客户端计算机，以便它们信任颁发给 NPS 的证书。

- 你可以从公共 CA （如 VeriSign）购买服务器证书。 如果使用此方法，请确保选择客户端计算机已信任的 CA。 若要确定客户端计算机是否信任 CA，请在客户端计算机上打开 "证书" Microsoft 管理控制台 (MMC) 管理单元，然后查看本地计算机和当前用户的 "受信任的根证书颁发机构" 存储。 如果这些证书存储区中有来自 CA 的证书，则客户端计算机将信任 CA，因此信任 CA 颁发的任何证书。

在采用 PEAP-MS-CHAP v2 的身份验证过程中，当 NPS 将其服务器证书发送到客户端计算机时，会发生服务器身份验证。 访问客户端将检查各种证书属性，以确定证书是否有效，以及在服务器身份验证期间是否适用于使用。 如果服务器证书满足最低服务器证书要求并且由访问客户端信任的 CA 颁发，则 NPS 已成功通过客户端的身份验证。

当用户尝试连接到网络类型的凭据并尝试登录时，将发生用户身份验证。 NPS 接收凭据并执行身份验证和授权。 如果用户已成功进行身份验证和授权，并且客户端计算机成功通过了 NPS 的身份验证，则会授予连接请求。

### <a name="key-steps"></a>关键步骤

在规划使用身份验证方法的过程中，可以使用以下步骤。

- 确定你计划提供的网络访问类型，如无线、VPN、802.1 支持 X 的交换机和拨号访问。

- 确定要用于每种类型的访问的身份验证方法。 建议使用提供强大安全性的基于证书的身份验证方法;但是，部署 PKI 可能并不可行，因此其他身份验证方法可能会为网络提供更好的平衡。

- 如果要部署 EAP-TLS，请规划 PKI 部署。 这包括规划要用于服务器证书和客户端计算机证书的证书模板。 它还包括确定如何将证书注册到域成员计算机和非域成员计算机，以及如何确定是否要使用智能卡。

- 如果要部署 PEAP-MS-CHAP v2，请确定是要安装 AD CS 以便向 NPSs 颁发服务器证书，还是要从公共 CA （如 VeriSign）购买服务器证书。

### <a name="plan-network-policies"></a>规划网络策略

NPS 使用网络策略来确定是否授权了从 RADIUS 客户端接收的连接请求。 NPS 还使用用户帐户的拨入属性来做出授权决定。

因为网络策略按照它们在 NPS 管理单元中的显示顺序进行处理，所以请计划在策略列表中首先放置最严格的策略。 对于每个连接请求，NPS 都尝试将策略的条件与连接请求属性进行匹配。 NPS 会按顺序检查每个网络策略，直到找到匹配项为止。 如果找不到匹配项，则会拒绝连接请求。

### <a name="key-steps"></a>关键步骤

在规划网络策略的过程中，可以使用以下步骤。

- 确定网络策略的首选 NPS 处理顺序，从最严格到最小限制。

- 确定策略状态。 策略状态可以是 "已启用" 或 "已禁用" 的值。 如果启用了该策略，则 NPS 将在执行授权时评估策略。 如果未启用策略，则不会对其进行评估。

- 确定策略类型。 你必须确定策略是否设计为在连接请求匹配策略的条件时授予访问权限，或者是否将策略设计为在该策略的条件与连接请求匹配时拒绝访问。 例如，如果要显式拒绝对 Windows 组成员的无线访问，则可以创建指定组、无线连接方法以及策略类型设置为 "拒绝访问" 的网络策略。

- 确定是否希望 NPS 忽略作为策略的组成员的用户帐户的拨入属性。 如果未启用此设置，则用户帐户的拨入属性将覆盖在网络策略中配置的设置。 例如，如果配置了向用户授予访问权限的网络策略，但该用户的用户帐户的拨入属性设置为 "拒绝访问"，则该用户将被拒绝访问。 但是，如果启用 "忽略用户帐户拨入属性" 策略类型设置，则会向同一用户授予对网络的访问权限。

- 确定策略是否使用策略源设置。 此设置允许您轻松指定所有访问请求的源。 可能的源是终端服务网关 (TS 网关) 、远程访问服务器 (VPN 或拨号) 、DHCP 服务器、无线访问点和健康注册机构服务器。 或者，您可以指定供应商特定的源。

- 确定必须匹配的条件，才能应用网络策略。

- 如果连接请求匹配网络策略的条件，则确定应用的设置。

- 确定是否要使用、修改或删除默认的网络策略。

## <a name="plan-nps-accounting"></a>规划 NPS 记帐

NPS 提供记录 RADIUS 记帐数据的功能，如用户身份验证和记帐请求，分为以下三种格式： IAS 格式、数据库兼容格式和 Microsoft SQL Server 日志记录。

IAS 格式和数据库兼容格式在本地 NPS 上以文本文件格式创建日志文件。

SQL Server 日志记录提供了记录到与 SQL Server 2000 或 SQL Server 2005 XML 兼容的数据库的功能，从而扩展了 RADIUS 记帐以利用日志记录到关系数据库的优点。

### <a name="key-steps"></a>关键步骤

在规划 NPS 记帐期间，可以使用以下步骤。

- 确定是要将 NPS 记帐数据存储在日志文件中还是存储在 SQL Server 数据库中。

### <a name="nps-accounting-using-local-log-files"></a>使用本地日志文件的 NPS 记帐

记录日志文件中的用户身份验证和记帐请求主要用于进行连接分析和计费，还可用作一种安全调查工具，提供一种方法，用于在攻击后跟踪恶意用户的活动。

### <a name="key-steps"></a>关键步骤

使用本地日志文件规划 NPS 记帐时，可以使用以下步骤。

- 确定要用于 NPS 日志文件的文本文件格式。

- 选择要记录的信息的类型。 可以记录记帐请求、身份验证请求和定期状态。

- 确定要用于存储日志文件的硬盘位置。

- 设计日志文件备份解决方案。 存储日志文件的硬盘位置应该是一个可让你轻松备份数据的位置。 此外，应通过为存储日志文件的文件夹配置访问控制列表 (ACL) 来保护硬盘位置。

- 确定要创建新日志文件的频率。 如果希望基于文件大小创建日志文件，请确定 NPS 在创建新日志文件之前允许的最大文件大小。

- 确定是否希望 NPS 在硬盘用尽存储空间时删除旧的日志文件。

- 确定要用于查看记帐数据并生成报告的应用程序。

### <a name="nps-sql-server-logging"></a>NPS SQL Server 日志记录

如果需要会话状态信息、报表创建和数据分析目的，以及用于集中和简化记帐数据的管理，则使用 NPS SQL Server 日志记录。

NPS 提供使用 SQL Server 日志记录来记录从一个或多个网络访问服务器接收的用户身份验证和记帐请求，并将其发送到运行 Microsoft SQL Server 桌面引擎 MSDE 2000 的计算机上的数据源 \( \) ，或超过 SQL Server 2000 的任何版本 SQL Server。

记帐数据从 XML 格式的 NPS 传递到数据库中的存储过程，该存储过程支持结构化查询语言 \( SQL \) 和 XML \( SQLXML \) 。 将用户身份验证和记帐请求记录到符合 XML 的 SQL Server 数据库中，可使多个 NPSs 具有一个数据源。

### <a name="key-steps"></a>关键步骤

使用 NPS 来规划 NPS 记帐 SQL Server 日志记录时，可以使用以下步骤。

- 确定你或组织中的另一个成员是否有 SQL Server 2000 或 SQL Server 2005 关系数据库开发体验，并了解如何使用这些产品来创建、修改、管理和管理 SQL Server 数据库。

- 确定是在 NPS 上还是在远程计算机上安装 SQL Server。

- 设计将在 SQL Server 数据库中使用的存储过程，以处理包含 NPS 记帐数据的传入 XML 文件。

- 设计 SQL Server 的数据库复制结构和流。

- 确定要用于查看记帐数据并生成报告的应用程序。

- 计划使用在所有记帐请求中发送类属性的网络访问服务器。 类属性在访问-接受消息中发送到 RADIUS 客户端，并可用于将记帐请求消息与身份验证会话关联。 如果类属性由网络访问服务器在会计请求消息中发送，则可以使用它来匹配记帐和身份验证记录。 属性的唯一序列号、服务重新启动时间和服务器地址的组合必须是服务器接受的每个身份验证的唯一标识。

- 计划使用支持过渡记帐的网络访问服务器。

- 计划使用发送记帐和记帐关闭消息的网络访问服务器。

- 计划使用支持存储和转发记帐数据的网络访问服务器。 如果网络访问服务器无法与 NPS 通信，则支持此功能的网络访问服务器可以存储记帐数据。 当 NPS 可用时，网络访问服务器会将存储的记录转发到 NPS，从而提高通过不提供此功能的网络访问服务器进行记帐的可靠性。

- 计划始终在网络策略中配置 "帐户-间歇间隔" 属性。 "帐户间歇间隔" 属性设置网络访问服务器发送的每个临时更新之间的间隔 (秒) 。 根据 RFC 2869，"帐户临时间隔" 属性的值不能小于60秒或1分钟，并且不应小于600秒或10分钟。 有关详细信息，请参阅 RFC 2869 "RADIUS 扩展"。

- 确保已在 NPSs 上启用定期状态的日志记录。

