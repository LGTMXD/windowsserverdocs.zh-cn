---
title: 规划软件定义的网络基础结构
description: 本主题提供有关如何规划软件定义的网络 (SDN) 基础结构部署的信息。
manager: grcusanz
ms.topic: get-started-article
ms.assetid: ea7e53c8-11ec-410b-b287-897c7aaafb13
ms.author: anpaul
author: AnirbanPaul
ms.date: 08/10/2018
ms.openlocfilehash: 60ba3ea51bf958f2cc5fa598e4f1323bd5631a80
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/07/2020
ms.locfileid: "87962171"
---
# <a name="plan-a-software-defined-network-infrastructure"></a>规划软件定义的网络基础结构

>适用于：Windows Server（半年频道）、Windows Server 2016

了解软件定义的网络基础结构（包括硬件和软件先决条件）的部署规划。


## <a name="prerequisites"></a>先决条件
本主题介绍了一些硬件和软件先决条件，其中包括：

-   **已配置安全组、日志文件位置和动态 DNS 注册**你必须为网络控制器部署准备你的数据中心，这需要一个或多个计算机或 vm 以及一个计算机或 VM。 部署网络控制器之前，必须配置安全组、日志文件位置 (如果需要) 和动态 DNS 注册。  如果尚未为网络控制器部署准备数据中心，请参阅[部署网络控制器的安装和准备要求](Installation-and-Preparation-Requirements-for-Deploying-Network-Controller.md)了解详细信息。

-   **物理网络** 你需要访问物理网络设备，以配置 Vlan、路由、BGP、数据中心桥接 (ETS) 如果使用 RDMA 技术，以及数据中心桥接 (PFC) 如果使用基于 RoCE 的 RDMA 技术。 本主题介绍第3层交换机/路由器上的手动交换机配置以及 BGP 对等互连，或者 (RRAS) 虚拟机上的路由和远程访问服务器。

-   **物理计算主机** 这些主机运行 Hyper-v，并需要宿主 SDN 基础结构和租户虚拟机。  为了获得最佳性能，这些主机中需要特定的网络硬件，这将在**网络硬件**部分的后面部分进行介绍。


## <a name="physical-network-and-compute-host-configuration"></a>物理网络和计算主机配置

每个物理计算主机都需要通过一个或多个网络适配器连接到物理交换机端口 () 。  第2层[VLAN](https://en.wikipedia.org/wiki/Virtual_LAN)支持划分为多个逻辑网段的网络。

>[!TIP]
>在访问模式或未标记的逻辑网络中使用 VLAN 0。

>[!IMPORTANT]
>Windows Server 2016 软件定义的网络支持是和覆盖的 IPv4 寻址。 不支持 IPv6。

### <a name="logical-networks"></a>Logical networks

#### <a name="management-and-hnv-provider"></a>管理和 HNV 提供程序

所有物理计算主机都必须访问管理逻辑网络和 HNV 提供程序逻辑网络。  出于 IP 地址规划目的，每个物理计算主机都必须至少有一个从管理逻辑网络分配的 IP 地址。 网络控制器需要保留 IP 地址作为 REST IP 地址。

DHCP 服务器可以为管理网络自动分配 IP 地址，也可以手动分配静态 IP 地址。 SDN 堆栈会自动从通过网络控制器指定和管理的 IP 池为单个 Hyper-v 主机的 HNV 提供程序逻辑网络分配 IP 地址。

>[!NOTE]
>仅在网络控制器主机代理收到特定租户虚拟机的网络策略后，网络控制器才将 HNV 提供程序的 IP 地址分配给物理计算主机。


|                                                               如果...                                                               |                                                                                                                                                                          则...                                                                                                                                                                           |
|-----------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|                                                  逻辑网络使用 Vlan，                                                  |                                                                 物理计算主机必须连接到有权访问这些 Vlan 的中继交换机端口。 请务必注意，计算机主机上的物理网络适配器不能激活任何 VLAN 筛选。                                                                 |
|                使用交换嵌入组合 (将) 设置为多个 NIC 组成员，例如网络适配器，                |                                                                                                                        必须将该特定主机的所有 NIC 组成员连接到相同的第2层广播域。                                                                                                                         |
| 物理计算主机正在运行其他基础结构虚拟机，如网络控制器、SLB/MUX 或网关， | 该主机必须为托管的每个虚拟机的管理逻辑网络分配一个额外的 IP 地址。<p>此外，每个 SLB/MUX 基础结构虚拟机必须具有为 HNV 提供程序逻辑网络保留的 IP 地址。 如果无法保留 IP 地址，则可能会导致网络上存在重复的 IP 地址。 |

---

有关 Hyper-v 网络虚拟化 (可用于在 Microsoft SDN 部署中虚拟化网络的 HNV) 的信息，请参阅[Hyper-v 网络虚拟化](../technologies/hyper-v-network-virtualization/Hyper-V-Network-Virtualization.md)。



#### <a name="gateways-and-the-software-load-balancer"></a>网关和软件负载均衡器

需要为网关和 SLB 使用创建和设置其他逻辑网络。 请确保为这些网络获取正确的 IP 前缀、VLAN Id 和网关 IP 地址。


|                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|---------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|   **传输逻辑网络**   | RAS 网关和 SLB/MUX 使用传输逻辑网络来交换 BGP 对等互连信息和北/南 (外部内部) 租户通信。 此子网的大小通常小于其他子网。 只有运行 RAS 网关或 SLB/MUX 虚拟机的物理计算主机需要使用这些 Vlan 中继连接到此子网，并且在计算主机的网络适配器连接到的交换机端口上可访问此子网。 每个 SLB/MUX 或 RAS 网关虚拟机均从传输逻辑网络静态分配一个 IP 地址。 |
| **公共 VIP 逻辑网络**  |                                                                                                                             公共 VIP 逻辑网络需要具有可在云环境以外路由的 IP 子网前缀 (通常可路由) 。  外部客户端使用这些 IP 地址来访问虚拟网络中的资源，包括站点到站点网关的前端 VIP。                                                                                                                             |
| **专用 VIP 逻辑网络** |                                                                                                                                                                                       不需要将专用 VIP 逻辑网络路由到云外部，因为它仅用于从内部云客户端（例如 SLB Manange 或私有服务）访问的 Vip。                                                                                                                                                                                       |
|   **GRE VIP 逻辑网络**   |                                                                                                                                           GRE VIP 网络是一个子网，专为定义分配给网关虚拟机的 VIP 而存在，这些虚拟机运行在用于 S2S GRE 连接类型的 SDN 构造上。 无需在物理交换机或路由器中预配置此网络，也无需分配 VLAN。                                                                                                                                            |

---


#### <a name="sample-network-topology"></a>示例网络拓扑
更改环境的示例 IP 子网前缀和 VLAN Id。


| **网络名称** |  **子网**  | **掩盖** | **卡车上的 VLAN ID** | **网关**  |                                                           **预订 (示例) **                                                           |
|------------------|--------------|----------|----------------------|--------------|-------------------------------------------------------------------------------------------------------------------------------------------------|
|    管理    | 10.184.108.0 |    24    |          7           | 10.184.108.1 | 10.184.108.1 –路由器 10.184.108.4-网络控制器 10.184.108.10-计算主机 110.184.108.11-计算主机 210.184.108-计算主机 X |
|   HNV 提供程序   |  10.10.56.0  |    23    |          11          |  10.10.56.1  |                                                    10.10.56.1 –路由器 10.10.56.2-SLB/MUX1                                                     |
|     传输      |  10.10.10.0  |    24    |          10          |  10.10.10.1  |                                                               10.10.10.1 –路由器                                                               |
|    公共 VIP    |  41.40.40.0  |    27    |          不可用          |  41.40.40.1  |                                    41.40.40.1 –路由器 41.40.40.2-SLB/MUX VIP 41.40.40.3-IPSec S2S VPN VIP                                    |
|   专用 VIP    |  20.20.20.0  |    27    |          不可用          |  20.20.20.1  |                                                        20.20.20.1-默认 GW (路由器)                                                          |
|     GRE VIP      |  31.30.30.0  |    24    |          不可用          |  31.30.30.1  |                                                             31.30.30.1-默认 GW                                                             |

---

### <a name="logical-networks-required-for-rdma-based-storage"></a>基于 RDMA 的存储所需的逻辑网络

如果使用基于 RDMA 的存储，请为每个物理适配器定义 VLAN 和子网， (计算和存储主机中的每个节点) 两个适配器。

>[!IMPORTANT]
>若要正确应用 (QoS) 的服务质量，物理交换机需要使用带标记的 VLAN 进行 RDMA 通信。

| **网络名称** |  **子网**  | **掩盖** | **卡车上的 VLAN ID** | **网关**  |                                                           **预订 (示例) **                                                            |
|------------------|--------------|----------|----------------------|--------------|--------------------------------------------------------------------------------------------------------------------------------------------------|
|     Storage1     |  10.60.36.0  |    25    |          8           |  10.60.36.1  |  10.60.36.1 –路由器<p>10.60.36-计算主机 X<p>10.60.36-计算主机 Y<p>10.60.36-计算群集<p>10.60.36-存储群集  |
|     Storage2     | 10.60.36.128 |    25    |          9           | 10.60.36.129 | 10.60.36.129 –路由器<p>10.60.36-计算主机 X<p>10.60.36-计算主机 Y<p>10.60.36-计算群集<p>10.60.36-存储群集 |

---


## <a name="routing-infrastructure"></a>路由基础结构

如果要使用脚本部署 SDN 基础结构，则必须在物理网络上相互路由管理、HNV 提供程序、传输和 VIP 子网。

\(对于 VIP 子网，下一跃点的路由信息 \) 由 SLB/MUX 和 RAS 网关播发到使用内部 BGP 对等互连的物理网络。 VIP 逻辑网络没有分配 VLAN 并且未在第2层交换机中预配置 (例如，机箱内交换机) 。

你需要在你的 SDN 基础结构使用的路由器上创建一个 BGP 对等方，以接收由 SLB/Mux 和 RAS 网关播发的 VIP 逻辑网络的路由。 BGP 对等互连只需发生一种方式 (从 SLB/MUX 或 RAS 网关到外部 BGP 对等) 。  在路由的第一层上，你可以使用静态路由或其他动态路由协议（如 OSPF），但是，如前文所述，VIP 逻辑网络的 IP 子网前缀需要从物理网络路由到外部 BGP 对等节点。

BGP 对等互连通常在作为网络基础结构一部分的托管交换机或路由器中进行配置。 也可以在具有远程访问服务器 (RAS) 角色安装在仅路由模式下的 Windows Server 上配置 BGP 对等机。 必须将网络基础结构中的 BGP 路由器对等节点配置为拥有自己的 ASN，并允许从分配给 SDN 组件 \( SLB/MUX 和 RAS 网关的 ASN 进行对等互连 \) 。 您必须从您的物理路由器或该路由器控制的网络管理员处获取以下信息：

- 路由器 ASN
- 路由器 IP 地址
- 供 SDN 组件使用的 ASN (可以是专用 ASN 范围内的任意数字) 

>[!NOTE]
>SLB/MUX 不支持4个字节的 Asn。 必须向 SLB/MUX 以及它所连接的路由器 wo 分配两个字节 Asn。 你可以在环境中的其他地方使用4个字节的 Asn。

你或网络管理员必须配置 BGP 路由器对等方，以接受来自你的 RAS 网关和 SLB/Mux 正在使用的传输逻辑网络的 ASN 和 IP 地址或子网地址的连接。

有关详细信息，请参阅[ (BGP) 边界网关协议](../../../remote/remote-access/bgp/Border-Gateway-Protocol-BGP.md)。

## <a name="default-gateways"></a>默认网关
配置为连接到多个网络（例如物理主机和网关虚拟机）的计算机必须配置有一个默认网关。 在用于访问 Internet 的适配器上配置默认网关。

对于虚拟机，请遵循以下规则确定要用作默认网关的网络：

1. 如果虚拟机连接到传输网络，则使用传输逻辑网络作为默认网关，或者，如果它是多宿主到传输网络或任何其他网络，则使用该逻辑网络。
2. 如果虚拟机仅连接到管理网络，请使用管理网络作为默认网关。
3. 将 HNV 提供程序网络用于 SLB/Mux 和 RAS 网关。 不要将 HNV 提供程序网络用作默认网关。
4. 请勿直接将虚拟机连接到 Storage1、Storage2、公有 VIP 或专用 VIP 网络。

对于 Hyper-v 主机和存储节点，请使用管理网络作为默认网关。  存储网络绝不能分配有默认网关。


## <a name="network-hardware"></a>网络硬件

你可以使用以下部分来规划网络硬件部署。

### <a name="network-interface-cards-nics"></a>网络接口卡 (NIC)

Hyper-v 主机中使用的网络接口卡 (Nic) ，存储主机需要特定功能才能实现最佳性能。

 (RDMA) 的远程直接内存访问是一种内核旁路技术，它可以在不使用主机 CPU 的情况下传输大量数据，从而释放 CPU 以执行其他工作。

交换机嵌入组合 (集) 是一种备用 NIC 组合解决方案，可用于在 Windows Server 2016 中包含 Hyper-v 的环境和软件定义的网络 (SDN) 堆栈。 将一些 NIC 组合功能集成到 Hyper-v 虚拟交换机。

有关详细信息，请参阅[ (RDMA 的远程直接内存访问) 和交换机嵌入组合 (设置) ](../../../virtualization//hyper-v-virtual-switch/RDMA-and-Switch-Embedded-Teaming.md)。

为了考虑 VXLAN 或 NVGRE 封装标头导致的租户虚拟网络流量中的开销，第2层 fabric 网络 (交换机和主机) 必须设置为大于或等于1674字节 \( （包括第2层以太网标头） \) 。

支持新的*EncapOverhead* advanced adapter 关键字的 nic 通过网络控制器主机代理自动设置 MTU。 不支持 new *EncapOverhead*关键字的 nic 需要使用*JumboPacket* \( 或等效关键字在每个物理主机上手动设置 MTU 大小 \) 。


### <a name="switches"></a>交换机

为环境选择物理交换机和路由器时，请确保它支持以下功能集：

- 需要交换机间 MTU 设置 \(\)
- MTU 设置为 >= 1674 字节， \( 包括 L2 以太网标头\)
- 需要 L3 协议 \(\)
- ECMP
- \(基于 BGP IETF RFC 4271 的 \) \- ECMP

实现应支持以下 IETF 标准中的必需语句。

- RFC 2545： "用于 IPv6 域间路由的 BGP-4 多协议扩展"
- RFC 4760： "用于 BGP 的多协议扩展-4"
- RFC 4893： "BGP 支持4个八位字节作为数字空间"
- RFC 4456： "BGP 路由反射：完全网格内部 BGP 的替代方法 (IBGP) "
- RFC 4724： "针对 BGP 的正常重新启动机制"

需要以下标记协议。

- 各种类型的通信的 VLAN 隔离
- 802.1 q 干线

以下各项提供了链接控件。

- \(仅当使用 RoCE 时，才需要服务质量 PFC\)
- 增强了流量选择 \( 802.1 qaz\)
- 基于优先级的流控制 \( 802.1 p/Q 和 802.1 q b b\)

以下各项提供了可用性和冗余。

- 需要交换机可用性 () 
- 高可用性路由器需要执行网关功能。 为此，可以使用多底盘交换机 \ 路由器或诸如 VRRP 这样的技术。

以下各项提供了管理功能。

**Monitoring**

- 如果使用网络控制器进行物理交换机监视，则需要使用 SNMP v1 或 SNMP v2 () 
- \(如果使用网络控制器进行物理交换机监视，则需要使用 SNMP mib\)
- MIB-II (RFC 1213) 、LLDP、Interface MIB \( RFC 2863 \) 、-MIB、IP-MIB、ip 转发-Mib、Q-LLDB、BRIDGE-MIB、IEEE8023-MIB、

以下关系图显示了一个示例四节点设置。 为清楚起见，第一个关系图只显示网络控制器，第二个显示网络控制器和软件负载平衡器，第三个关系图显示网络控制器、软件负载平衡器和网关。

这些关系图不显示存储网络和 Vnic。 如果计划使用基于 SMB 的存储，则需要这些存储。

如果正确的逻辑网络) 存在正确的网络连接，则可以在任何物理计算主机之间重新分发基础结构和租户虚拟机 (。



## <a name="switch-configuration-examples"></a>交换机配置示例

为帮助配置物理交换机或路由器， [MICROSOFT SDN Github 存储库](https://github.com/microsoft/SDN/tree/master/SwitchConfigExamples)中提供了适用于各种交换机型号和供应商的一组示例配置文件。 提供了详细的自述文件和经过测试的命令行界面 (用于特定交换机的 CLI) 命令。


## <a name="compute"></a>计算
所有 Hyper-v 主机都必须安装 Windows Server 2016，启用 Hyper-v，并使用至少一个连接到管理逻辑网络的物理适配器创建外部 Hyper-v 虚拟交换机。 主机必须可通过分配给管理主机 vNIC 的管理 IP 地址来访问。

可以使用与 Hyper-v 兼容的任何存储类型。

> [!TIP]
> 如果对所有虚拟交换机使用相同的名称，则很方便，但这并不是必需的。 如果计划通过脚本进行部署，请参阅与 `vSwitchName` config.psd1 文件中的变量关联的注释。

**主机计算要求**下表显示了示例部署中使用的四个物理主机的最低硬件和软件要求。

主机|硬件要求|软件要求|
--------|-------------------------|-------------------------
|物理 Hyper-v 主机|4 核 2.66 GHz CPU<p>32 GB RAM<p>300 GB 磁盘空间<p>1 Gb/s (或更快) 物理网络适配器|操作系统： Windows Server 2016<p>Hyper-v 角色已安装|


**SDN 基础结构虚拟机角色要求**

角色|vCPU 要求|内存需求|磁盘要求|
--------|---------------------|-----------------------|---------------------
|网络控制器 (三个节点) |4个 vcpu|建议使用 4 GB (8 gb) |OS 驱动器为 75 GB
|SLB/MUX (三个节点) |8 个 vCPU|建议 8 GB|OS 驱动器为 75 GB
|RDS 网关<p> (三个节点网关的单个池，两个活动，一个被动) |8 个 vCPU|建议 8 GB|OS 驱动器为 75 GB
|用于 SLB/MUX 对等互连的 RAS 网关 BGP 路由器<p> (或者使用 ToR 交换机作为 BGP 路由器) |2个 vcpu|2 GB|OS 驱动器为 75 GB|


如果使用 VMM 进行部署，则 VMM 和其他非 SDN 基础结构需要额外的基础结构虚拟机资源。 有关其他信息，请参阅[System Center Technical Preview 的最低硬件建议。](https://technet.microsoft.com/library/dn997303.aspx)

## <a name="extending-your-infrastructure"></a>扩展基础结构
基础结构的大小和资源要求取决于你计划承载的租户工作负荷虚拟机。 基础结构虚拟机的 CPU、内存和磁盘要求 (例如：网络控制器、SLB、网关等 ) 在上一个表中列出。 你可以根据需要添加更多的基础结构虚拟机以进行扩展。 但是，Hyper-v 主机上运行的任何租户虚拟机都具有自己的 CPU、内存和磁盘要求，你必须考虑这些要求。

当租户工作负荷虚拟机开始在物理 Hyper-v 主机上消耗过多的资源时，可以通过添加更多的物理主机来扩展基础结构。 这可以通过 Virtual Machine Manager 或使用 PowerShell 脚本 (完成，具体取决于你最初部署基础结构的方式) 通过网络控制器创建新的服务器资源。 如果需要为 HNV 提供商网络添加其他 IP 地址，可以使用主机可以使用的相应 IP 池) 创建新的逻辑子网 (。


## <a name="see-also"></a>另请参阅
[部署网络控制器](Installation-and-Preparation-Requirements-for-Deploying-Network-Controller.md) 
 的安装和准备要求[软件定义的网络 &#40;SDN&#41;](../Software-Defined-Networking--SDN-.md)



