---
title: RAS 网关高可用性
description: 你可以使用本主题来了解 Windows Server 2016 中的用于软件定义的网络 (SDN) 的 RAS 多租户网关的高可用性配置。
manager: grcusanz
ms.topic: get-started-article
ms.assetid: 34d826c9-65bc-401f-889d-cf84e12f0144
ms.author: anpaul
author: AnirbanPaul
ms.openlocfilehash: 0bdf116aeb8f154290b528b9ba96fbb4a8b34426
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/07/2020
ms.locfileid: "87969554"
---
# <a name="ras-gateway-high-availability"></a>RAS 网关高可用性

>适用于：Windows Server（半年频道）、Windows Server 2016

你可以使用本主题来了解 RAS 多租户网关的高可用性配置，用于软件定义的网络 (SDN) 。

本主题包含以下各节：

-   [RAS 网关概述](#bkmk_overview)

-   [网关池概述](#bkmk_pools)

-   [RAS 网关部署概述](#bkmk_deployment)

-   [RAS 网关与网络控制器的集成](#bkmk_integration)

## <a name="ras-gateway-overview"></a><a name="bkmk_overview"></a>RAS 网关概述
如果你的组织是 (CSP) 或具有多个租户的企业的云服务提供商，则可以在多租户模式下部署 RAS 网关，以提供进出虚拟网络和物理网络（包括 Internet）的网络流量。

可以在多租户模式下部署 RAS 网关作为边缘网关，将租户客户网络流量路由到租户虚拟网络和资源。

当你部署可提供高可用性和故障转移的 RAS 网关 Vm 的多个实例时，你将部署网关池。 在 Windows Server 2012 R2 中，所有网关 Vm 构成单个池，这会使网关部署的逻辑分离变得有点困难。  Windows Server 2012 R2 网关为网关 Vm 提供了1:1 冗余部署，导致无法利用站点到站点 (S2S) VPN 连接的可用容量。

Windows Server 2016 中解决了此问题，该服务器提供多个网关池，这些池可以是不同的逻辑分离类型。 M + N 冗余的新模式允许更有效的故障转移配置。

有关 RAS 网关的更多概述信息，请参阅[Ras 网关](../../../../remote/remote-access/ras-gateway/RAS-Gateway.md)。

## <a name="gateway-pools-overview"></a><a name="bkmk_pools"></a>网关池概述
在 Windows Server 2016 中，可以在一个或多个池中部署网关。

下图显示了在虚拟网络之间提供流量路由的不同类型的网关池。

![RAS 网关池](../../../media/RAS-Gateway-High-Availability/ras_pools.png)

每个池都具有以下属性。

-   每个池都是 M + N 冗余的。 这意味着，"N" 个备用网关 vm 数由 "N" 个备用网关 vm 备份。 N (备用网关) 的值始终小于或等于 M (活动网关) 。

-   池可以执行任何单个网关功能-Internet 密钥交换版本 2 (IKEv2) S2S、第3层 (L3) 以及通用路由封装 (GRE) ，或者池可以执行所有这些功能。

-   可以将单个公共 IP 地址分配给所有池，也可以分配给部分池。 这样做会大大减少必须使用的公共 IP 地址数，因为可以让所有租户在单个 IP 地址上连接到云。 以下部分介绍高可用性和负载平衡介绍了此功能的工作原理。

-   可以通过在池中添加或删除网关 Vm 来轻松地向上或向下缩放网关池。 删除或添加网关不会中断池提供的服务。 你还可以添加和删除整个网关池。

-   单个租户的连接可在池中的多个池和多个网关上终止。 但是，如果某个租户在**全部**类型网关池中有连接终止，则无法订阅其他**所有**类型或单个类型的网关池。

网关池还提供启用其他方案的灵活性：

-   单租户池-可以创建一个池以供一个租户使用。

-   如果通过合作伙伴 (经销商) 渠道销售云服务，则可以为每个分销商创建单独的池集。

-   多个池可以提供相同的网关功能，但容量不同。 例如，可以创建支持高吞吐量和低吞吐量 IKEv2 S2S 连接的网关池。

## <a name="ras-gateway-deployment-overview"></a><a name="bkmk_deployment"></a>RAS 网关部署概述
下图演示了 (CSP) RAS 网关部署的典型云服务提供商。

![RAS 网关部署概述](../../../media/RAS-Gateway-High-Availability/ras_csp_deploy.png)

对于这种类型的部署，会将网关池部署到软件负载平衡器 (SLB) ，这使 CSP 能够为整个部署分配单个公共 IP 地址。 租户的多个网关连接可在多个网关池上终止，也可在池中的多个网关上终止。 这在上图中通过 IKEv2 S2S 连接进行了说明，但同样适用于其他网关功能，如 L3 和 GRE 网关。

在插图中，MT BGP 设备是具有 BGP 的 RAS 多租户网关。 多租户 BGP 用于动态路由。 租户的路由是集中式的-单个点（称为路由反射器 (RR) ）处理所有租户站点的 BGP 对等互连。 RR 本身分布于池中的所有网关。 这会导致一种配置，其中租户 (数据路径的连接) 在多个网关上终止，但是租户 (BGP 对等点-控制路径) 仅在一个网关上。

序列图中分离了 BGP 路由器，用于说明这一集中式路由概念。 网关 BGP 实现还提供了传输路由，使云能够充当两个租户站点之间路由的传输点。 这些 BGP 功能适用于所有网关功能。

## <a name="ras-gateway-integration-with-network-controller"></a><a name="bkmk_integration"></a>RAS 网关与网络控制器的集成
RAS 网关与 Windows Server 2016 中的网络控制器完全集成。 部署 RAS 网关和网络控制器后，网络控制器将执行以下功能。

-   部署网关池

-   每个网关上的租户连接配置

-   当网关出现故障时，将网络流量切换到备用网关

以下部分提供有关 RAS 网关和网络控制器的详细信息。

-   [ (IKEv2、L3 和 GRE 的网关连接的预配和负载平衡) ](#bkmk_provisioning)

-   [IKEv2 S2S 的高可用性](#bkmk_ike)

-   [GRE 的高可用性](#bkmk_gre)

-   [L3 转发网关的高可用性](#bkmk_l3)

### <a name="provisioning-and-load-balancing-of-gateway-connections-ikev2-l3-and-gre"></a><a name="bkmk_provisioning"></a> (IKEv2、L3 和 GRE 的网关连接的预配和负载平衡) 
当租户请求网关连接时，请求将发送到网络控制器。 网络控制器配置了有关所有网关池的信息，包括每个池中每个池的容量和每个网关的容量。 网络控制器为连接选择了正确的池和网关。 此选择基于连接的带宽要求。 网络控制器使用 "最佳匹配" 算法来有效地选择池中的连接。 如果这是租户的第一个连接，则也指定连接的 BGP 对等点。

网络控制器为连接选择 RAS 网关后，网络控制器将为网关上的连接预配所需的配置。 如果连接是 IKEv2 S2S 连接，则网络控制器还会在 SLB 池上设置网络地址转换 (NAT) 规则;SLB 池中的此 NAT 规则将来自租户的连接请求定向到指定的网关。 租户由源 IP 进行区分，这应该是唯一的。

> [!NOTE]
> L3 和 GRE 连接绕过 SLB 并直接连接到指定的 RAS 网关。  这些连接要求远程终结点路由器 (或其他第三方设备) 必须正确配置才能与 RAS 网关连接。

如果为连接启用了 BGP 路由，则会通过 RAS 网关启动 BGP 对等互连，并在本地和云网关之间交换路由。 BGP (获知的路由或静态配置的路由（如果未使用 BGP) 发送到网络控制器）。 然后，网络控制器将路由联结到安装了租户 Vm 的 Hyper-v 主机。 此时，租户流量可以路由到正确的本地站点。 网络控制器还创建关联的 Hyper-v 网络虚拟化策略，这些策略指定网关位置，并将其联结到 Hyper-v 主机。

### <a name="high-availability-for-ikev2-s2s"></a><a name="bkmk_ike"></a>IKEv2 S2S 的高可用性
池中的 RAS 网关包括不同租户的连接和 BGP 对等互连。 每个池都有 "活动网关" 和 "N" 备用网关。

网络控制器按以下方式处理网关失败。

-   网络控制器会对所有池中的网关进行不断 ping 操作，并可检测到失败或失败的网关。 网络控制器可以检测以下类型的 RAS 网关故障。

    -   RAS 网关 VM 故障

    -   RAS 网关正在其上运行的 Hyper-v 主机的故障

    -   RAS 网关服务故障

    网络控制器存储所有已部署的活动网关的配置。 配置包括连接设置和路由设置。

-   当网关出现故障时，它会影响网关上的租户连接，以及位于其他网关但其 RR 位于失败的网关上的租户连接。 后一连接的停机时间小于前者的停机时间。 当网络控制器检测到失败的网关时，它会执行以下任务。

    -   从计算主机中删除受影响的连接的路由。

    -   删除这些主机上的 Hyper-v 网络虚拟化策略。

    -   选择备用网关，将其转换为活动网关，并配置网关。

    -   更改 SLB 池上的 NAT 映射，以将连接点连接到新网关。

-   同时，在新的活动网关上出现配置时，将重新建立 IKEv2 S2S 连接和 BGP 对等互连。 可以通过云网关或本地网关启动连接和 BGP 对等互连。 网关刷新其路由，并将其发送到网络控制器。 网络控制器了解网关发现的新路由后，网络控制器会将路由和关联的 Hyper-v 网络虚拟化策略发送到受故障影响的租户的 Vm 所在的 Hyper-v 主机。 此网络控制器活动类似于新连接设置的情况，这种情况下，只会在更大的规模上进行。

### <a name="high-availability-for-gre"></a><a name="bkmk_gre"></a>GRE 的高可用性
网络控制器的 RAS 网关故障转移响应过程（包括故障检测、将连接和路由配置复制到备用网关、故障转移受影响的连接的 BGP/静态路由 (包括对计算主机和 BGP 重新对) 等机上的路由进行提款和重新排列），以及在计算主机上重新配置 Hyper-v 网络虚拟化策略-对于 GRE 网关和连接是相同的 但是，在重新建立 GRE 连接的过程中，也有一些额外的要求。

![GRE 的高可用性](../../../media/RAS-Gateway-High-Availability/ras_ha.png)

部署网关时，会为每个 RAS 网关 VM 分配一个动态 IP 地址 (DIP) 。 此外，还会为每个网关 VM 分配一个虚拟 IP 地址 (VIP) 用于 GRE 高可用性。 仅将 Vip 分配给池中可接受 GRE 连接的网关，而不会分配到非 GRE 池。 使用 BGP 将分配的 Vip 播发到机架 (TOR) 交换机的顶部，然后进一步将 Vip 广告到云物理网络中。 这使得可以从 GRE 连接的另一端所在的远程路由器或第三方设备访问网关。 此 BGP 对等互连不同于租户级别的 BGP 对等互连，可用于交换租户路由。

在进行 GRE 连接设置时，网络控制器将选择一个网关，在所选网关上配置 GRE 终结点，并返回分配的网关的 VIP 地址。 然后，将此 VIP 配置为远程路由器上的目标 GRE 隧道地址。

当网关出现故障时，网络控制器会将失败的网关和其他配置数据的 VIP 地址复制到备用网关。 当备用网关变为活动状态时，它会将 VIP 播发到其 TOR 交换机，并将其转到物理网络。 远程路由器会继续将 GRE 隧道连接到相同的 VIP，路由基础结构可确保将数据包路由到新的活动网关。

### <a name="high-availability-for-l3-forwarding-gateways"></a><a name="bkmk_l3"></a>L3 转发网关的高可用性
Hyper-v 网络虚拟化 L3 转发网关是数据中心的物理基础结构和 Hyper-v 网络虚拟化云中虚拟化的基础结构之间的桥梁。 在多租户 L3 转发网关上，每个租户使用其自己的 VLAN 标记的逻辑网络连接到租户的物理网络。

当新租户创建新的 L3 网关时，网络控制器网关 Service Manager 会选择可用的网关 VM，并使用) 空间 IP 地址从租户的 VLAN 标记逻辑网络) 中空间 IP 地址 (来配置新租户接口 (CA。 IP 地址用作远程 (物理网络) 网关上的对等 IP 地址，是到达租户的 Hyper-v 网络虚拟化网络的下一跃点。

与 IPsec 或 GRE 网络连接不同，TOR 交换机将无法动态了解租户的 VLAN 标记网络。 需要在 TOR 交换机上配置租户的 VLAN 标记网络的路由，并在物理基础结构和网关之间配置所有中间交换机和路由器，以确保端到端连接。  下面是一个示例 CSP 虚拟网络配置，如下图所示。

|网络|子网|VLAN ID|默认网关|
|-----------|----------|-----------|-------------------|
|Contoso L3 逻辑网络|10.127.134.0/24|1001|10.127.134.1|
|Woodgrove L3 逻辑网络|10.127.134.0/24|1002|10.127.134.1|

下面是示例租户网关配置，如下图所示。

|租户名称|L3 网关 IP 地址|VLAN ID|对等 IP 地址|
|---------------|-------------------------|-----------|-------------------|
|Contoso|10.127.134.50|1001|10.127.134.55|
|Woodgrove|10.127.134.60|1002|10.127.134.65|

下面是 CSP 数据中心中的这些配置的示意图。

![L3 转发网关的高可用性](../../../media/RAS-Gateway-High-Availability/ras_fwdgw.png)

L3 转发网关上下文中的网关故障、故障检测和网关故障转移过程类似于 IKEv2 和 GRE RAS 网关的过程。 不同之处在于处理外部 IP 地址的方式。

当网关 VM 状态变为不正常时，网络控制器从池中选择一个备用网关，然后重新设置备用网关上的网络连接和路由。 在移动连接时，L3 转发网关的高可用 CA 空间 IP 地址也会随租户的 CA 空间 BGP IP 地址一起移动到新的网关 VM。

由于在故障转移过程中将 L3 对等互连 IP 地址移到新的网关 VM，因此远程物理基础结构将再次能够连接到此 IP 地址，并随后连接到 Hyper-v 网络虚拟化工作负载。 对于 BGP 动态路由，因为 CA 空间 BGP IP 地址被移到新的网关 VM，所以远程 BGP 路由器可以重新建立对等互连，并再次了解所有 Hyper-v 网络虚拟化路由。

> [!NOTE]
> 必须单独配置 TOR 开关和所有中间路由器，才能使用 VLAN 标记的逻辑网络进行租户通信。 此外，L3 故障转移仅限于以这种方式配置的机架。 因此，必须仔细配置 L3 网关池，手动配置必须单独完成。



